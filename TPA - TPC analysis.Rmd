---
title: "TPA - Growth rate and TPC modelling"
author: "Hugo Scharfenstein"
date: '`r Sys.Date()`'
output: html_document
---

# Load packages
```{r}
#Data import and export packages
library(readxl)
library(writexl)
#Data wrangling packages
library(tidyverse)
library(broom)
library(rstatix)
#Packages for growth rates/TPCs 
library(nlstools)
library(rTPC)
library(nls.multstart)
library(MuMIn)
library(nlsMicrobio)
library(minpack.lm)
library(car)
#Data visualisation packages
library(SciViews)
library(ggpubr)
library(factoextra)
library(RColorBrewer)
```

# Import data
```{r}
#Set seed for reproducibility
set.seed(1234567)

#Optical density (OD) data from TPA
TPA.df <- read_xlsx("./Physiological datasets - EE & TPA.xlsx", sheet = 3)

#OD data for calibration curves
CC.df <- read_xlsx("./Physiological datasets - EE & TPA.xlsx", sheet = 2)

#Re-level temperature treatments
TPA.df$Growth_temperature <- ordered(TPA.df$Growth_temperature, levels = c('21', '23', '25', '27', '29', '31'))

#Prepare labels for plot facets
growth.labs <- c("Growth cycle 1", "Growth cycle 2")
names(growth.labs) <- c('1', "2")
temperature.labs <- c('21°C', '23°C', '25°C', '27°C', '29°C', '31°C', '33°C')
names(temperature.labs) <- c('21', '23', '25', '27', '29', '31', '33')
treatment.labs <- c('Fluc-short', 'Fluc-med', 'Fluc-long', 'Cont-ele', 'Cont-amb')
names(treatment.labs) <- c('TP1', 'TP2', 'TP3', 'TP4', 'TP5')
```

# Calibration curves visualisation
```{r}
#In vivo fluorescence vs. cell density
IVF.plot <- CC.df %>%
  filter(Nutrient_treatment == "IMK") %>%
  mutate(Growth_temperature = as.factor(Growth_temperature)) %>%
  ggplot(aes(y=CellD, x= IVF_680nm, colour = Growth_temperature)) +
  geom_point() +
  geom_smooth(method='lm', formula= y~x, se = F, size = 1) +
  scale_y_continuous("Cell density (cells/ml)", expand = c(0,0), breaks = 0:1200000*200000, limits = c(0,1200000),
                     labels = scales::scientific) +
  scale_x_continuous(expand = c(0,0), breaks = 0:800*200, limits = c(0,800)) +
  scale_colour_manual(values = c("#313695", "#4575b4", "#abd9e9", "#000000", "#f46d43", "#d73027", "#a50026")) +
  xlab(expression(italic("In vivo")~fluorescence~('680nm'))) +
  stat_regline_equation(label.x = c(10,10,10,10, 10, 10, 10), 
                        label.y = c(1150000,1100000,1050000,1000000, 950000, 900000, 850000),
                        aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~")), size=4) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  guides(colour = guide_legend(title = "Temperature (°C)",override.aes = aes(label = "")))
IVF.plot

#Optical density at 670nm vs. cell density
OD670.plot <- CC.df %>%
  filter(Nutrient_treatment == "IMK") %>%
  mutate(Growth_temperature = as.factor(Growth_temperature)) %>%
  ggplot(aes(y=CellD, x= OD_670nm, colour = Growth_temperature)) +
  geom_point() +
  geom_smooth(method='lm', formula= y~x, se = F, size = 0.75, linetype='solid') +
  scale_y_continuous("Cell density (cells/ml)", expand = c(0,0), breaks = 0:1200000*200000, limits = c(0,1200000),
                     labels = scales::scientific) +
  scale_x_continuous(expand = c(0,0), limits = c(0,0.4)) +
  scale_colour_manual(values = c("#313695", "#4575b4", "#abd9e9", "#000000", "#f46d43", "#d73027", "#a50026")) +
  xlab(expression(Optical~density~('670nm'))) +
  stat_regline_equation(label.x = c(0.01,0.01,0.01,0.01, 0.01, 0.01, 0.01), 
                        label.y = c(1150000,1100000,1050000,1000000, 950000, 900000, 850000),
                        aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~")), size=4) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  guides(colour = guide_legend(title = "Temperature (°C)",override.aes = aes(label = "")))
OD670.plot

#Optical density at 750nm vs. cell density
OD750.plot <- CC.df %>%
  filter(Nutrient_treatment == "IMK") %>%
  mutate(Growth_temperature = as.factor(Growth_temperature)) %>%
  ggplot(aes(y=CellD, x= OD_750nm, colour = Growth_temperature)) +
  geom_point() +
  geom_smooth(method='lm', formula= y~x, se = F, size = 0.75, linetype='solid') +
  scale_y_continuous("Cell density (cells/ml)", expand = c(0,0), breaks = 0:1200000*200000, limits = c(0,1200000), labels = scales::scientific) +
  scale_x_continuous(expand = c(0,0), limits = c(0,0.4)) +
  scale_colour_manual(values = c("#313695", "#4575b4", "#abd9e9", "#000000", "#f46d43", "#d73027", "#a50026")) +
  xlab(expression(Optical~density~('750nm'))) +
  stat_regline_equation(label.x = c(0.01,0.01,0.01,0.01, 0.01, 0.01, 0.01), 
                        label.y = c(1150000,1100000,1050000,1000000, 950000, 900000, 850000),
                        aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~")), size=4) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  guides(colour = guide_legend(title = "Temperature (°C)",override.aes = aes(label = "")))
OD750.plot

#Combine the calibration curves
CC.plots <- ggarrange(IVF.plot + rremove('ylab'),
                     OD670.plot,
                     OD750.plot + rremove('ylab'),
                     common.legend = TRUE,
                     legend = 'right',
                     heights = c(4, 4,4),
                     widths = c(0.5, 0.5, 0.5),
                     align = "hv",
                     ncol = 1) 
CC.plots
```

# Convert OD data to cell density measurements
```{r}
#Subtract IMK blank to OD_670nm values (accounts for OD of IMK and plate)
TPA.df <- TPA.df %>%
  group_by(Growth_cycle, Growth_temperature, Measurement_date) %>%
  mutate(OD_670nm = OD_670nm-IMK_blank) %>%
  ungroup()

#Transform OD into cell density measurements using calibration curves specific to each temperature
TPA.df <- TPA.df %>%
  mutate(CellD=case_when(str_detect(Growth_temperature,"21") ~ 3500000*OD_670nm-79000,
                         str_detect(Growth_temperature,"23") ~ 2800000*OD_670nm+12000,
                         str_detect(Growth_temperature,"25") ~ 3500000*OD_670nm-47000,
                         str_detect(Growth_temperature,"27") ~ 4300000*OD_670nm+320,
                         str_detect(Growth_temperature,"29") ~ 3000000*OD_670nm-62000,
                         str_detect(Growth_temperature,"31") ~ 2600000*OD_670nm+26000,
                    )) %>%
  mutate(log_CellD = log10(CellD))
```

# Visualise growth curves
```{r}
#Growth cuvres for IMK replete treatment
GC.plot <- TPA.df %>%
  ggplot(aes(y = CellD, x = Time_day, colour = EE_treatment)) +
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 21), aes(xintercept = 30), colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 23), aes(xintercept = 26), colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 25), aes(xintercept = 26), colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 27), aes(xintercept = 24), colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 29), aes(xintercept = 22), colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 31), aes(xintercept = 18), colour="black", size = 0.5, linetype = 'dashed') +
  geom_vline(data=filter(TPA.df, Growth_cycle == 2 & Growth_temperature == 27), aes(xintercept = 10), colour="black", size = 0.5, linetype = 'solid') +
  geom_vline(data=filter(TPA.df, Growth_cycle == 2 & Growth_temperature == 29), aes(xintercept = 10), colour="black", size = 0.5, linetype = 'solid') +
  geom_vline(data=filter(TPA.df, Growth_cycle == 2 & Growth_temperature == 31), aes(xintercept = 10), colour="black", size = 0.5, linetype = 'solid') +
  geom_hline(aes(yintercept = 100000), colour="grey", size = 0.5, linetype = 'solid') + 
  geom_smooth(aes(fill = EE_treatment), method=mgcv::gam, formula = y~s(x, bs = "cs", k = 4), se=T, size=0.75, alpha = 0.25) +
  geom_point(size=3, pch=20, shape=0) +
  facet_grid(Growth_temperature ~ Growth_cycle, labeller = labeller(Growth_temperature=temperature.labs, Growth_cycle=growth.labs),
             scales = 'free_y') +
  scale_x_continuous('Time (days)', breaks=0:52*8, expand =c(0,0),limits = c(0,52)) +
  scale_y_continuous('Cell density (cells/ml)', limits = c(0,NA), labels = scales::scientific) +
  scale_colour_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(#aspect.ratio = 10/40,
        panel.grid.minor = element_blank(), 
        panel.grid.major = element_blank(),
        panel.spacing = unit(1, "lines"),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        strip.background.x = element_rect(size = 0, fill = "white"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "top",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 12, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        labs(colour = "Experimental evolution treatment") +
        guides(fill = FALSE)
GC.plot

#Growth cuvres for IMK replete treatment
GC_log.plot <- TPA.df %>%
  ggplot(aes(y = log_CellD, x = Time_day, colour = EE_treatment)) +
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 21), aes(xintercept = 30),
             colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 23), aes(xintercept = 26),
             colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 25), aes(xintercept = 26),
             colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 27), aes(xintercept = 24),
             colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 29), aes(xintercept = 22),
             colour="black", size = 0.5, linetype = 'dashed') + 
  geom_vline(data=filter(TPA.df, Growth_cycle == 1 & Growth_temperature == 31), aes(xintercept = 18),
             colour="black", size = 0.5, linetype = 'dashed') +
  geom_vline(data=filter(TPA.df, Growth_cycle == 2 & Growth_temperature == 27), aes(xintercept = 10),
             colour="black", size = 0.5, linetype = 'solid') +
  geom_vline(data=filter(TPA.df, Growth_cycle == 2 & Growth_temperature == 29), aes(xintercept = 10),
             colour="black", size = 0.5, linetype = 'solid') +
  geom_vline(data=filter(TPA.df, Growth_cycle == 2 & Growth_temperature == 31), aes(xintercept = 10),
             colour="black", size = 0.5, linetype = 'solid') +
  geom_hline(aes(yintercept = 5), colour="grey", size = 0.5, linetype = 'solid') + 
  geom_smooth(aes(fill = EE_treatment), method=mgcv::gam, formula = y~s(x, bs = "cs", k = 4), se=T, size=0.75, alpha = 0.25) +
  geom_point(size=3, pch=20, shape=0) +
  facet_grid(Growth_temperature ~ Growth_cycle, labeller = labeller(Growth_temperature=temperature.labs,
                                                                    Growth_cycle=growth.labs),
             scales = 'free_y') +
  scale_x_continuous('Time (days)', breaks=0:52*8, expand =c(0,0),limits = c(0,52)) +
  scale_y_continuous('Cell density (log10 transformed)', limits = c(NA,NA)) +
  scale_colour_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(#aspect.ratio = 10/40,
        panel.grid.minor = element_blank(), 
        panel.grid.major = element_blank(),
        panel.spacing = unit(1, "lines"),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        strip.background.x = element_rect(size = 0, fill = "white"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "top",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 12, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        labs(colour = "Experimental evolution treatment") +
        guides(fill = FALSE)
GC_log.plot

#Combine GC plots
GC.plots <- ggarrange(GC.plot,
                      GC_log.plot,
                      labels = c("(a)", "(b)"),
                      common.legend = T,
                      heights = c(1, 1),
                      widths = c(1, 1),
                      nrow = 2,
                      ncol = 1,
                      align = 'hv')
GC.plots
```

# Growth rate calculation

## Prepare data frames for growth model fitting
```{r}
#Growth cycle 1
GC1.df <- TPA.df %>%
  filter(Growth_cycle == 1) %>%
  filter(CellD > 0) %>%
  mutate(log10CellD = log10(CellD))

#Growth cycle 2
GC2.df <- TPA.df %>%
  filter(Growth_cycle == 2) %>%
  filter(Growth_temperature != 21 )

GC2_21C.df <- TPA.df %>%
  filter(Growth_cycle == 2 & Growth_temperature == 21) %>%
  filter(!(EE_treatment == 'TP3' & Time_day %in% c(27, 30))) #Remove anomalous timepoints for TP3

GC2.df <- rbind(GC2.df, GC2_21C.df) %>%
  filter(CellD > 0) %>%
  mutate(log10CellD = log10(CellD)) %>%
  filter(log10CellD > 0) %>%
  ungroup()
```

## Define the equations to be used for modelling of growth rates
```{r}
#Gompertz growth models
gompertz_calc <- function(time, y0, mumax, K, lambda){
y <- y0 + (K - y0) * exp(-exp(mumax * exp(1) * (lambda - time)/((K - y0) * log(10)) + 1))
}

#Buchanan growth models (with and without lag phase as a parameter)
buchanan_calc <- function(time, y0, mumax, K, lambda){
y <- y0 + (time >= lambda) * (time <= (lambda + (K - y0) * log(10)/mumax)) * mumax * (time - lambda)/log(10) + (time >= lambda) * (time > (lambda + (K - y0) * log(10)/mumax)) * (K - y0)
}

buchanan_calc_no_lag <- function(time, y0, mumax, K){
y <- y0 + (time <= ((K - y0) * log(10)/mumax)) * mumax * time/log(10) + (time > ((K - y0) * log(10)/mumax)) *  (K - y0)
}

#Baranyi growth models (with and without lag phase and without carrying capacity as parameters)
baranyi_calc <- function(time, y0, mumax, K, lambda){
y <- K + log10((-1 + exp(mumax * lambda) + exp(mumax * time))/(exp(mumax * time) - 1 + exp(mumax * lambda) * 10^(K - y0)))
}

baranyi_calc_no_lag <- function(time, y0, mumax, K){
y <- K - log10(1 + (10^(K - y0) - 1) * exp(-mumax * time))
}

baranyi_calc_no_K <- function(time, y0, mumax, lambda){
y <- y0 + mumax * time/log(10) + log10(exp(-mumax * time) * (1 - exp(-mumax * lambda)) + exp(-mumax * lambda))
}
#Equations were obtained from: https://github.com/padpadpadpad/Padfield_2019_ISME_bact_phage_temperature/blob/master/scripts/growth_curve_models.R
```

## Define the starting parameters
```{r}
#Starting cell density (y0)
y0 <- GC2.df %>% 
  group_by(Growth_temperature, Lineage) %>% 
  filter(Time_day == min(Time_day)) %>% 
  ungroup() %>%
  mutate(y0_min = min(log10CellD)) %>%
  mutate(y0_max = max(log10CellD)) %>% 
  select(y0_min, y0_max) %>% 
  distinct()

#Maximum cell density (carrying capacity; K)
K <- GC2.df %>% 
  group_by(Growth_temperature, Lineage) %>% 
  filter(Time_day == max(Time_day)) %>% 
  ungroup() %>%
  mutate(K_min = min(log10CellD)) %>%
  mutate(K_max = max(log10CellD)) %>% 
  select(K_min, K_max) %>% 
  distinct()
```

## Option 1: parametric nonlinear growth model fitting using nls.multstart
```{r}
#Fit various growth models
GrowthR.nls_fits <- GC2.df %>%
  select(Growth_temperature, EE_treatment, Lineage, Time_day, log10CellD) %>%
  group_by(Growth_temperature, EE_treatment, Time_day) %>%
  mutate(sd_log10CellD = sd(log10CellD)) %>%
  ungroup() %>%
  group_by(Growth_temperature, EE_treatment, Lineage) %>%
  nest(data = c(Time_day, log10CellD, sd_log10CellD)) %>%
  mutate(gompertz = map(data, ~ nls_multstart(log10CellD ~ gompertz_calc(time = Time_day, y0, mumax, K, lambda),
                     data = .x,
                     iter = 500,
                     start_lower = c(y0 = y0$y0_min, mumax = -0.15, K = K$K_min, lambda = 1), #Adjust starting params here
                     start_upper = c(y0 = y0$y0_max, mumax = 0.3, K = K$K_max, lambda = 18), #Adjust starting params here
                     supp_errors = 'Y',
                     convergence_count = 100,
                     lower = c(y0 = log10(10000), mumax = -0.2, K = log10(10000), lambda = 0), #Adjust lower boundaries here
                     upper = c(y0 = log10(200000), mumax = 0.4, K = log10(2000000), lambda = 30), #Adjust upper boundaries here
                     na.action = na.omit,
                     modelweights = 1/sd_log10CellD)),
         buchanan = map(data, ~ nls_multstart(log10CellD ~ buchanan_calc(time = Time_day, y0, mumax, K, lambda),
                     data = .x,
                     iter = 500,
                     start_lower = c(y0 = y0$y0_min, mumax = -0.15, K = K$K_min, lambda = 1), #Adjust starting params here
                     start_upper = c(y0 = y0$y0_max, mumax = 0.3, K = K$K_max, lambda = 18), #Adjust starting params here
                     supp_errors = 'Y',
                     convergence_count = 100,
                     lower = c(y0 = log10(10000), mumax = -0.2, K = log10(10000), lambda = 0), #Adjust lower boundaries here
                     upper = c(y0 = log10(200000), mumax = 0.4, K = log10(2000000), lambda = 30), #Adjust upper boundaries here
                     na.action = na.omit,
                     modelweights = 1/sd_log10CellD)),
  buchanan_no_lag = map(data, ~ nls_multstart(log10CellD ~ buchanan_calc_no_lag(time = Time_day, y0, mumax, K),
                     data = .x,
                     iter = 500,
                     start_lower = c(y0 = y0$y0_min, mumax = -0.15, K = K$K_min), #Adjust starting params here
                     start_upper = c(y0 = y0$y0_max, mumax = 0.3, K = K$K_max), #Adjust starting params here
                     supp_errors = 'Y',
                     convergence_count = 100,
                     lower = c(y0 = log10(10000), mumax = -0.2, K = log10(10000)), #Adjust lower boundaries here
                     upper = c(y0 = log10(200000), mumax = 0.4, K = log10(2000000)), #Adjust upper boundaries here
                     na.action = na.omit,
                     modelweights = 1/sd_log10CellD)),
         baranyi = map(data, ~ nls_multstart(log10CellD ~ baranyi_calc(time = Time_day, y0, mumax, K, lambda),
                     data = .x,
                     iter = 500,
                     start_lower = c(y0 = y0$y0_min, mumax = -0.15, K = K$K_min, lambda =1), #Adjust starting params here
                     start_upper = c(y0 = y0$y0_max, mumax = 0.3, K = K$K_max, lambda = 18), #Adjust starting params here
                     supp_errors = 'Y',
                     convergence_count = 100,
                     lower = c(y0 = log10(10000), mumax = -0.2, K = log10(10000), lambda = 0), #Adjust lower boundaries here
                     upper = c(y0 = log10(200000), mumax = 0.4, K = log10(2000000), lambda = 30), #Adjust upper boundaries here
                     na.action = na.omit,
                     modelweights = 1/sd_log10CellD)),
    baranyi_no_K = map(data, ~ nls_multstart(log10CellD ~ baranyi_calc_no_K(time = Time_day, y0, mumax, lambda),
                     data = .x,
                     iter = 500,
                     start_lower = c(y0 = y0$y0_min, mumax = -0.15, lambda =1), #Adjust starting params here
                     start_upper = c(y0 = y0$y0_max, mumax = 0.3, lambda = 18), #Adjust starting params here
                     supp_errors = 'Y',
                     convergence_count = 100,
                     lower = c(y0 = log10(10000), mumax = -0.2, lambda = 0), #Adjust lower boundaries here
                     upper = c(y0 = log10(200000), mumax = 0.4, lambda = 30), #Adjust upper boundaries here
                     na.action = na.omit,
                     modelweights = 1/sd_log10CellD)),
  baranyi_no_lag = map(data, ~ nls_multstart(log10CellD ~ baranyi_calc_no_lag(time = Time_day, y0, mumax, K),
                     data = .x,
                     iter = 500,
                     start_lower = c(y0 = y0$y0_min, mumax = -0.15, K = K$K_min), #Adjust starting params here
                     start_upper = c(y0 = y0$y0_max, mumax = 0.3, K = K$K_max), #Adjust starting params here
                     supp_errors = 'Y',
                     convergence_count = 100,
                     lower = c(y0 = log10(10000), mumax = -0.2, K = log10(10000)), #Adjust lower boundaries here
                     upper = c(y0 = log10(200000), mumax = 0.4, K = log10(2000000)), #Adjust upper boundaries here
                     na.action = na.omit,
                     modelweights = 1/sd_log10CellD))) %>%
  ungroup()

#Stack different model fits to the same column
GrowthR.nls_stack <- select(GrowthR.nls_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', gompertz:baranyi_no_lag) 

#Retrieve model fit information
GrowthR.nls_info <- GrowthR.nls_stack %>%
  filter(fit != 'NULL') %>%
  mutate(., summary = map(fit, glance),
         AICc =  map_dbl(fit, MuMIn::AICc)) %>%
  dplyr::select(-fit) %>%
  unnest(summary)

#Retrieve model fit parameters
GrowthR.nls_params <- GrowthR.nls_stack %>%
  mutate(params = map(fit, tidy)) %>%
  unnest(params)

#Get confidence intervals for parameters
GrowthR.nls_CI <- GrowthR.nls_stack %>%
  filter(fit != 'NULL') %>%
  mutate(cis = map(fit, confint2),
         cis = map(cis, data.frame),
         cis = map(cis, rownames_to_column)) %>%
  unnest(cis) %>%
  rename(term = rowname, conf.low = X2.5.., conf.high = X97.5..) %>%
  select(-fit)

#Merge confidence intervals with parameters
GrowthR.nls_CI_PMS <- merge(GrowthR.nls_params, GrowthR.nls_CI, by = intersect(names(GrowthR.nls_params), names(GrowthR.nls_CI))) %>%
  mutate(Replicate = case_when(str_detect(Lineage, "_1") ~ '1',
                               str_detect(Lineage, "_2") ~ '2',
                               str_detect(Lineage, "_3") ~ '3',
                               str_detect(Lineage, "_4") ~ '4',
                               str_detect(Lineage, "_5") ~ '5',
                               str_detect(Lineage, "_6") ~ '6',
                               TRUE ~ 'Error'))

#Get predictions 
GrowthR.nls_npreds <- tibble(Time_day = seq(min(GC2.df$Time_day), max(GC2.df$Time_day), length.out = 200))
GrowthR.nls_npreds_max_min <- GC2.df %>%
  group_by(Growth_temperature, Lineage) %>%
  summarise(., min_Time_day = min(Time_day), max_Time_day = max(Time_day)) %>%
  ungroup()

#Augment predictions using fits
GrowthR.nls_preds <- GrowthR.nls_stack %>%
  filter(fit != 'NULL') %>%
  group_by(Growth_temperature, Lineage, model_name) %>%
  mutate(p = map(fit, augment, newdata = GrowthR.nls_npreds)) %>%
  unnest(p) %>%
  ungroup() %>%
  merge(., GrowthR.nls_npreds_max_min, by = c('Growth_temperature', 'Lineage')) %>%
  group_by(Growth_temperature, Lineage) %>%
  filter(., Time_day > unique(min_Time_day) & Time_day < unique(max_Time_day)) %>%
  mutate(prediction_id = cur_group_id()) %>%
  select(-fit)

#Visualise fits and parameter estimates
GrowthR.nls_fit_plot <- GrowthR.nls_preds %>%
  group_by(Growth_temperature, Lineage) %>%
  ggplot() +
  geom_line(aes(Time_day, .fitted, group = prediction_id, colour = model_name), alpha = 0.5) +
  geom_point(aes(Time_day, log10(CellD)), size = 1.5, shape = 21, fill = "black", alpha = 0.1, data = GC2.df) +
  facet_wrap(.~Growth_temperature, labeller = labeller(Growth_temperature=temperature.labs), ncol = 2) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        strip.text.x=element_text(size = 14, face="bold"),
        strip.text.y=element_text(size = 14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "right", 
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
    labs(x = "Time (days)", y = "Log10 Cell density", colour = "Model")
GrowthR.nls_fit_plot

GrowthR.nls_params_plot <- GrowthR.nls_CI_PMS %>%
  filter(term == 'mumax') %>%
  ggplot(aes(col = model_name), position_dodge(width = 1)) +
  geom_point(aes(Lineage, estimate), size = 1.5) +
  geom_linerange(aes(Lineage, ymin = conf.low, ymax = conf.high)) +
  facet_wrap(.~Growth_temperature, labeller = labeller(Growth_temperature=temperature.labs), ncol = 2) +
  scale_y_continuous(limits = c(-0.2, 0.4)) +
  scale_x_discrete(labels = c('Fluc-short_R1', 'Fluc-short_R2', 'Fluc-short_R3', 'Fluc-short_R4', 'Fluc-short_R5', 'Fluc-short_R6',
                              'Fluc-med_R1', 'Fluc-med_R2', 'Fluc-med_R3', 'Fluc-med_R4', 'Fluc-med_R5', 'Fluc-med_R6',
                              'Fluc-long_R1', 'Fluc-long_R2', 'Fluc-long_R3', 'Fluc-long_R4', 'Fluc-long_R5', 'Fluc-long_R6',
                              'Cont-ele_R1', 'Cont-ele_R2', 'Cont-ele_R3', 'Cont-ele_R4', 'Cont-ele_R5', 'Cont-ele_R6',
                              'Cont-amb_R1', 'Cont-amb_R2', 'Cont-amb_R3', 'Cont-amb_R4', 'Cont-amb_R5', 'Cont-amb_R6')) +
  scale_colour_brewer(palette = "Dark2") +
  coord_flip() +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "right", 
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  labs(x = 'Lineage', y = 'Parameter estimate (µmax)', colour = 'Model', shape = 'Experimental evolution treatment')
GrowthR.nls_params_plot
#Baranyi, baranyi_no_lag and gompertz models provide poor mumax estimates, especially at 21 and 31°C

#Select best model fits based on smallest CI or AIC scores
GrowthR.nls_df <- merge(GrowthR.nls_CI_PMS, GrowthR.nls_info, 
                          by = intersect(names(GrowthR.nls_CI_PMS), 
                                         names(GrowthR.nls_info))) %>%
  group_by(Growth_temperature, Lineage, term) %>%
  mutate(conf = conf.high - conf.low) %>%
  filter(term == 'mumax') %>%
  filter(!(model_name %in% c('baranyi', 'baranyi_no_lag', 'gompertz'))) %>% #Remove these models, they provided erroneous mumax estimates 
  filter(AICc - min(AICc) <= 2) %>% #Only keep models within Δ2 AIC of the lowest score
  filter(conf == min(conf)) %>% #Keep model that provides best CI for the parameter of interest (mumax)
  ungroup()

#Check which model is best fit according to previous filtering criteria
GrowthR.nls_best_model <- GrowthR.nls_df %>%
  dplyr::select(Growth_temperature, model_name, Lineage, estimate) %>%
  ungroup() %>%
  count(model_name) #Buchanan_no_lag overwhelmingly provides best fit

GrowthR.df <- merge(GrowthR.nls_CI_PMS, GrowthR.nls_info, 
                          by = intersect(names(GrowthR.nls_CI_PMS), 
                                         names(GrowthR.nls_info))) %>%
  filter(term == 'mumax') %>%
  filter(model_name == 'buchanan_no_lag') %>%
  select(Growth_temperature, EE_treatment, Lineage, estimate) %>%
  rename(mumax = estimate) %>%
  group_by(Growth_temperature, EE_treatment) %>%
  mutate(ave_mumax = mean(mumax)) %>%
  mutate(sd_mumax = sd(mumax)) %>%
  ungroup() 
```

## Option 2: two point calculation of growth rates
```{r}
#Growth cycle 1
GrowthR_twop_GC1.df <- GC1.df %>%
  group_by(Growth_temperature, Lineage) %>%
  mutate(Timepoint = case_when(CellD == min(CellD) ~ 'start',
                               CellD == max(CellD) ~ 'end',
                               TRUE ~ 'remove')) %>%
  filter(Timepoint != 'remove') %>%
  select(Growth_temperature, EE_treatment, Lineage, Time_day, CellD, Timepoint)

GrowthR_twop_GC1_start.df <- GrowthR_twop_GC1.df %>%
  filter(Timepoint == 'start') %>%
  rename(Time_day_start = Time_day,
         CellD_start = CellD) %>%
  select(-Timepoint)

GrowthR_twop_GC1_end.df <- GrowthR_twop_GC1.df %>%
  filter(Timepoint == 'end') %>%
  rename(Time_day_end = Time_day,
         CellD_end = CellD) %>%
  select(-Timepoint)

GrowthR_twop_GC1.df2 <- left_join(GrowthR_twop_GC1_start.df, GrowthR_twop_GC1_end.df) %>%
  group_by(Growth_temperature, Lineage) %>%
  filter(!(Growth_temperature %in% 21 & Lineage %in% 'TP4_3' & Time_day_end %in% 39)) %>%
  filter(!(Growth_temperature %in% 23 & Lineage %in% 'TP2_1' & Time_day_start %in% 1)) %>%
  mutate(Delta_t = Time_day_end-Time_day_start) %>%
  mutate(mu = (ln(CellD_end)-ln(CellD_start))/Delta_t) %>%
  mutate(div_day = mu/ln(2)) %>%
  mutate(gen_time = 1/div_day) %>%
  mutate(generations = case_when(Growth_temperature == 21 ~ 30/gen_time,
                                 Growth_temperature == 23 ~ 26/gen_time,
                                 Growth_temperature == 25 ~ 26/gen_time,
                                 Growth_temperature == 27 ~ 24/gen_time,
                                 Growth_temperature == 29 ~ 22/gen_time,
                                 Growth_temperature == 31 ~ 18/gen_time)) %>%
  distinct() %>%
  ungroup() %>%
  group_by(Growth_temperature, EE_treatment) %>%
  mutate(median_mu = median(mu)) %>%
  mutate(sd_mu = sd(mu)) %>%
  mutate(median_div_day = median(div_day)) %>%
  mutate(sd_div_day = sd(div_day)) %>%
  mutate(median_gen_time = median(gen_time)) %>%
  mutate(sd_gen_time = sd(gen_time)) %>%
  mutate(median_generations = median(generations)) %>%
  mutate(sd_generations = sd(generations)) %>%
  mutate(Lineage = case_when(str_detect(Lineage, "_1") ~ '1',
                             str_detect(Lineage, "_2") ~ '2',
                             str_detect(Lineage, "_3") ~ '3',
                             str_detect(Lineage, "_4") ~ '4',
                             str_detect(Lineage, "_5") ~ '5',
                             str_detect(Lineage, "_6") ~ '6',
                             TRUE ~ 'Error')) %>%
  mutate(EE_treatment = case_when(str_detect(EE_treatment, 'TP1') ~ 'Fluc-short',
                                  str_detect(EE_treatment, 'TP2') ~ 'Fluc-med',
                                  str_detect(EE_treatment, 'TP3') ~ 'Fluc-long',
                                  str_detect(EE_treatment, 'TP4') ~ 'Cont-ele',
                                  str_detect(EE_treatment, 'TP5') ~ 'Cont-amb',
                                  TRUE ~ 'ERROR')) %>%
  select(Growth_temperature, EE_treatment, median_mu, sd_mu, median_div_day, sd_div_day, median_gen_time, sd_gen_time, 
         median_generations, sd_generations) %>%
  distinct()

#Plot for growth cycle 1
Gen_GC1.plot <- GrowthR_twop_GC1.df2 %>%
  ggplot(aes(colour = EE_treatment, fill = EE_treatment)) +
  geom_point(aes(x = Growth_temperature, y = median_generations), 
             position=position_dodge(width = 1),
             size = 1.5) +
  geom_linerange(aes(x = Growth_temperature,
                     ymin = median_generations-sd_generations,
                     ymax = median_generations+sd_generations),
                 position=position_dodge(width = 1)) +
  scale_colour_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB"),
                      guide = guide_legend(title.position="top", nrow = 1)) +
  scale_fill_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  #facet_wrap(~Growth_temperature) +
  #coord_flip() +
  labs(x = 'Growth temperature (°C)', y = 'Generations elapsed', colour = 'Experimental evolution treatment') +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        strip.text.x = element_text(size=14, face="bold"),
        strip.text.y = element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "top", 
        legend.direction = "horizontal",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"),
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  guides(fill = FALSE)
Gen_GC1.plot

#Growth cycle 2 (rough estimate, for sanity check of previously calculated growth rates)
GrowthR_twop.df2 <- GC2.df %>%
  group_by(Growth_temperature, Lineage) %>%
  mutate(Tstart = min(Time_day)) %>%
  mutate(Tend = max(Time_day)) %>%
  mutate(Timepoint = case_when(Time_day == min(Time_day) ~ 'start',
                               Time_day == max(Time_day) ~ 'end')) %>%
  na.omit() %>%
  mutate(mumax = ((ln(CellD[Timepoint == 'end'])/ln(CellD[Timepoint == 'end'])))/(Tend - Tstart)) %>%
  select(Growth_temperature, EE_treatment, Lineage, mumax) %>%
  distinct() %>%
  ungroup() %>%
  group_by(Growth_temperature, EE_treatment) %>%
  mutate(ave_mumax = mean(mumax)) %>%
  mutate(sd_mumax = sd(mumax)) %>%
  mutate(Model = 'twopoint')
```

## Visualise growth rates
```{r}
GrowthR.plot <- GrowthR.df %>% #Change this to 'GrowthR_twop.df' to compare mumax from model fitting and two point calculation
  mutate(Growth_temperature = as.numeric(as.character(Growth_temperature))) %>%
  ggplot(aes(x = Growth_temperature, y = ave_mumax, fill = EE_treatment, colour = EE_treatment)) +
  geom_linerange(aes(x = Growth_temperature, ymin = ave_mumax-sd_mumax, ymax = ave_mumax+sd_mumax),
                   position=position_dodge(width = 1)) +
  geom_point(position=position_dodge(width = 1), size = 1.5, pch = 20, shape = 0) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  scale_x_continuous('Temperature (ºC)', expand =c(0,0),limits = c(20,32)) +
  scale_y_continuous(expression(bold(Maximum~growth~rate~(d^-1))), limits = c(NA, NA)) +
  scale_colour_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), 
        strip.text.x=element_text(size = 14, face="bold"),
        strip.text.y=element_text(size = 14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        labs(colour = "Experimental evolution treatment") +
        guides(fill = FALSE)
GrowthR.plot
```

# Thermal performance curve (TPC) fitting

## Fit TPCs to each lineage using previously calculated growth rates
```{r}
#Prepare df for TPC fitting
TPC.df <- GrowthR.df %>%
  mutate(Growth_temperature = as.numeric(as.character(Growth_temperature))) %>%
  arrange(Growth_temperature) %>%
  group_by(Growth_temperature, EE_treatment) %>%
  ungroup() %>%
  dplyr::select(Growth_temperature, EE_treatment, Lineage, mumax, ave_mumax, sd_mumax)
  
#Fit TPCs to each lineage using multiple models 
TPC.fits <- TPC.df %>%
  dplyr::select(!ave_mumax) %>%
  group_by(Lineage) %>%
  nest(data = c(Growth_temperature, mumax, sd_mumax)) %>%
  mutate(thomas2017 = map(data, ~nls_multstart(mumax~thomas_2017(temp = Growth_temperature, a, b, c, d, e),
                        data = .x,
                        iter = c(4,4,4,4,4),
                        start_lower = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017') - 1,
                        start_upper = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017') + 1,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017'),
                        supp_errors = 'Y',
                        convergence_count = FALSE),
                        modelweights = 1/sd_mumax),
         thomas2012 = map(data, ~nls_multstart(mumax~thomas_2012(temp = Growth_temperature, a, b, c, topt),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2012') - 1,
                        start_upper = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2012') + 1,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2012'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2012'),
                        supp_errors = 'Y',
                        convergence_count = FALSE),
                        modelweights = 1/sd_mumax),
         lactin = map(data, ~nls_multstart(mumax~lactin2_1995(temp = Growth_temperature, a, b, tmax, delta_t),
                        data = .x,
                        iter = c(4,4,4,4),
                        start_lower = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'lactin2_1995') - 1,
                        start_upper = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'lactin2_1995') + 1,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'lactin2_1995'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'lactin2_1995'),
                        supp_errors = 'Y',
                        convergence_count = FALSE),
                        modelweights = 1/sd_mumax),
         kamykowski = map(data, ~nls_multstart(mumax~kamykowski_1985(temp = Growth_temperature, tmin, tmax, a, b, c),
                        data = .x,
                        iter = c(4,4,4,4,4),
                        start_lower = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985') - 1,
                        start_upper = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985') + 1,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985'),
                        supp_errors = 'Y',
                        convergence_count = FALSE),
                        modelweights = 1/sd_mumax),
         joehnk = map(data, ~nls_multstart(mumax~joehnk_2008(temp = Growth_temperature, rmax, topt, a, b , c),
                        data = .x,
                        iter = c(4,4,4,4,4),
                        start_lower = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008') - 1,
                        start_upper = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008') + 1,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008'),
                        supp_errors = 'Y',
                        convergence_count = FALSE),
                        modelweights = 1/sd_mumax))

#Stack models
TPC.stack <- dplyr::select(TPC.fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', thomas2017:joehnk)

#Get parameters provided by models
TPC.params <- TPC.stack %>%
  mutate(., est = map(fit, tidy)) %>%
  dplyr::select(-fit) %>%
  unnest(est)

#Get predictions using augment
TPC.newdata <- tibble(Growth_temperature = seq(min(TPC.df$Growth_temperature), max(TPC.df$Growth_temperature), length.out = 100))
TPC.preds <- TPC.stack %>%
  mutate(., rate_preds = map(fit, augment, newdata = TPC.newdata)) %>%
  dplyr::select(-fit) %>%
  unnest(rate_preds) %>%
  mutate(Replicate = case_when(str_detect(Lineage, "_1") ~ '1',
                               str_detect(Lineage, "_2") ~ '2',
                               str_detect(Lineage, "_3") ~ '3',
                               str_detect(Lineage, "_4") ~ '4',
                               str_detect(Lineage, "_5") ~ '5',
                               str_detect(Lineage, "_6") ~ '6',
                               TRUE ~ 'Error')) %>%
  select(EE_treatment, Lineage, Replicate, model_name, Growth_temperature, .fitted)

#Facet label names for TPC plots
treatment.labs <- c("Fluc-short", "Fluc-med", "Fluc-long", "Cont-ele", "Cont-amb")
names(treatment.labs) <- c("TP1", "TP2", "TP3", "TP4", "TP5")

#Prepare TPC.df2 for plotting
TPC.df2 <- TPC.df %>%
  mutate(Replicate = case_when(str_detect(Lineage, "_1") ~ '1',
                               str_detect(Lineage, "_2") ~ '2',
                               str_detect(Lineage, "_3") ~ '3',
                               str_detect(Lineage, "_4") ~ '4',
                               str_detect(Lineage, "_5") ~ '5',
                               str_detect(Lineage, "_6") ~ '6',
                               TRUE ~ 'Error')) %>%
  select(Growth_temperature, EE_treatment, Lineage, Replicate, mumax, ave_mumax, sd_mumax)

#Visualize TPCs
TPC.plot <- TPC.preds %>%
  group_by(EE_treatment, Growth_temperature) %>%
  ggplot(aes()) +
  geom_point(aes(Growth_temperature, mumax, group = interaction(Lineage, Replicate)), TPC.df2, size = 1.5, pch = 20, shape = 0) +
  geom_line(aes(Growth_temperature, .fitted, colour = model_name)) +
  facet_grid(EE_treatment~Replicate, labeller = labeller(EE_treatment = treatment.labs)) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  theme_bw() +
  scale_x_continuous('Temperature (ºC)', breaks= seq(20, 32, by = 4), expand =c(0,0), limits = c(20,32)) +
  scale_y_continuous(expression(bold(Maximum~growth~rate~(d^-1))), limits = c(NA,NA)) +
  scale_colour_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        panel.spacing.x = unit(1, "lines"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "top",
        title = element_text(size = 14, face = "bold"),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  labs(colour = "Model") +
  guides(fill = FALSE)
TPC.plot
#All models provide very similar fits, except kamykowski for TP4_1,2,3 & 5
```

## TPC model selection
```{r}
#Calculate measures of relative model fit (AIC, BIC, AICc)
TPC.model_ic <- TPC.stack %>%
  mutate(., info = map(fit, glance),
         AICc =  map_dbl(fit, MuMIn::AICc)) %>%
  #dplyr::select(-fit) %>%
  unnest(info) %>%
  dplyr::select(model_name, fit, sigma, AIC, AICc, BIC, df.residual)

#Filter for best model fit
TPC.model_selec <- TPC.model_ic %>%
  filter(AICc - min(AICc) <= 2) %>% #Filter out model averages that are less than Δ2AICc of the best model
  #filter(AICc == min(AICc)) %>% 
  dplyr::select(Lineage, model_name) %>%
  ungroup() %>%
  dplyr::select(-Lineage) %>%
  count(model_name)
#No obvious distinction of model per EE_treatment
#Joehnk followed by kamykowski and thomas2017 models provide best fits in a relatively equal number of cases, suggesting some model uncertainty
#Proceed with model averaging to avoid biases in TPC parameters linked to model selection
```

## TPC model averaging
```{r}
#Get weights of individual models
TPC.model_weights <- TPC.model_ic %>%
  filter(model_name %in% c('thomas2017', 'joehnk', 'kamykowski')) %>% #Keep three best models
  filter(AICc - min(AICc) <= 2) %>% #Filter out model averages that are less than Δ2AICc of the best model
  mutate(., weight = MuMIn::Weights(AICc))

dplyr::select(TPC.model_weights, Lineage, model_name, weight) %>%
  arrange(., desc(weight))

TPC.preds_ave <- left_join(TPC.preds, dplyr::select(TPC.model_weights, Lineage, model_name, weight)) %>%
  na.omit() %>% #Keeps the best model fit when the model average wasn't above Δ2AIC
  filter(!(Lineage == 'TP4_1' & model_name == 'kamykowski')) %>%
  filter(!(Lineage == 'TP4_2' & model_name == 'kamykowski')) %>%
  filter(!(Lineage == 'TP4_3' & model_name == 'kamykowski')) %>%
  filter(!(Lineage == 'TP4_5' & model_name == 'kamykowski')) %>%
  group_by(Lineage, Growth_temperature) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = weight+(weight_dif/2)) %>% #Adjust model weight since kamykowski CIs not obtained for some TP4 lineages
  select(-weight_dif) %>%
  summarise(., .fitted = sum(.fitted*weight)) %>%
  ungroup() %>%
  mutate(model_name = 'model_average') %>%
  mutate(EE_treatment = case_when(str_detect(Lineage, 'TP1') ~ 'TP1',
                                  str_detect(Lineage, 'TP2') ~ 'TP2',
                                  str_detect(Lineage, 'TP3') ~ 'TP3',
                                  str_detect(Lineage, 'TP4') ~ 'TP4',
                                  str_detect(Lineage, 'TP5') ~ 'TP5',
                                  TRUE ~ 'Error')) %>%
  mutate(Replicate = case_when(str_detect(Lineage, "_1") ~ '1',
                               str_detect(Lineage, "_2") ~ '2',
                               str_detect(Lineage, "_3") ~ '3',
                               str_detect(Lineage, "_4") ~ '4',
                               str_detect(Lineage, "_5") ~ '5',
                               str_detect(Lineage, "_6") ~ '6',
                               TRUE ~ 'Error')) %>%
  select(EE_treatment, Lineage, Replicate, model_name, Growth_temperature,.fitted)

#Calculate extra parameters from models
TPC.extra_params <- TPC.stack %>%
  mutate(., params = map(fit, calc_params)) %>%
  dplyr::select(-fit) %>%
  unnest(params)

#Get averaged parameter values based on previously calculated model weights
TPC.extra_params_ave <- left_join(TPC.extra_params, TPC.model_weights) %>%
  dplyr::select(!c(e, eh, q10, skewness, sigma, AIC, AICc, BIC, df.residual)) %>%
  na.omit() %>% 
  filter(model_name %in% c('thomas2017', 'joehnk', 'kamykowski')) %>% #Keep three best models
  filter(!(Lineage %in% 'TP1_2' & model_name %in% c('joehnk', 'thomas2017'))) %>% #Remove these models due to CTmin being -inf
  filter(!(Lineage %in% 'TP1_6' & model_name %in% c('joehnk', 'thomas2017'))) %>% #Remove these models due to CTmin being -inf
  mutate(weight = case_when(str_detect(Lineage, 'TP1_2') ~ 1, #Adjust model weight since only kamykowski remains
                            str_detect(Lineage, 'TP1_6') ~ 1,
                            .default = as.numeric(weight))) %>%
  group_by(Lineage) %>%
  summarise(., across(rmax:breadth, function(x){sum(x*weight)})) %>%
  mutate(model_name = 'model average') %>%
  mutate(EE_treatment = case_when(str_detect(Lineage, 'TP1') ~ 'TP1',
                                  str_detect(Lineage, 'TP2') ~ 'TP2',
                                  str_detect(Lineage, 'TP3') ~ 'TP3',
                                  str_detect(Lineage, 'TP4') ~ 'TP4',
                                  str_detect(Lineage, 'TP5') ~ 'TP5',
                                  TRUE ~ 'ERROR')) %>%
    mutate(Replicate = case_when(str_detect(Lineage, "_1") ~ '1',
                               str_detect(Lineage, "_2") ~ '2',
                               str_detect(Lineage, "_3") ~ '3',
                               str_detect(Lineage, "_4") ~ '4',
                               str_detect(Lineage, "_5") ~ '5',
                               str_detect(Lineage, "_6") ~ '6',
                               TRUE ~ 'Error')) %>%
  select(EE_treatment, Lineage, Replicate, model_name, ctmax, ctmin, topt, rmax, thermal_safety_margin, breadth) %>%
  pivot_longer(cols = ctmax:breadth, names_to = 'param', values_to = 'estimate') %>%
  group_by(EE_treatment, param) %>%
  mutate(med_estimate = median(estimate)) %>%
  mutate(param = case_when(str_detect(param, 'ctmax') ~ 'CTmax',
                           str_detect(param, 'ctmin') ~ 'CTmin',
                           str_detect(param, 'topt') ~ 'Topt',
                           str_detect(param, 'thermal_safety_margin') ~ 'TSM',
                           str_detect(param, 'breadth') ~ 'Tbr',
                           str_detect(param, 'rmax') ~ 'rmax',
                           TRUE ~ 'ERROR'))
```

## Bootstrap to obtain confidence intervals of lineage specific models
```{r}
#Get coefs for the models that were selected for averaging
TPC.thomas2017 <- TPC.fits %>%
  select(EE_treatment, Lineage, data, thomas2017) %>%
  mutate(., coefs_thomas2017 = map(thomas2017, coef))

TPC.kamykowski <- TPC.fits %>%
  select(EE_treatment, Lineage, data, kamykowski) %>%
  mutate(., coefs_kamykowski = map(kamykowski, coef)) %>%
  filter(!Lineage %in% c('TP4_1', 'TP4_2', 'TP4_3', 'TP4_5')) #Coefs do not allow for fitting with nlsLM 

TPC.joehnk <- TPC.fits %>%
  select(EE_treatment, Lineage, data, joehnk) %>%
  mutate(., coefs_joehnk = map(joehnk, coef))

#Refit each model using nlsLM
TPC.thomas2017 <- mutate(TPC.thomas2017, TPC.nlsLM_thomas2017 = 
                        map2(data, coefs_thomas2017, ~minpack.lm::nlsLM(mumax~thomas_2017(temp = Growth_temperature, a, b, c, d, e),
                        data = .x,
                        start = .y,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017'),
                        weights = 1/sd_mumax)))

TPC.kamykowski <- mutate(TPC.kamykowski, TPC.nlsLM_kamykowski = 
                        map2(data, coefs_kamykowski, ~minpack.lm::nlsLM(mumax~kamykowski_1985(temp = Growth_temperature, tmin, tmax, a, b, c),
                        data = .x,
                        start = .y,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985'),
                        weights = 1/sd_mumax)))

TPC.joehnk <- mutate(TPC.joehnk, TPC.nlsLM_joehnk = 
                     map2(data, coefs_joehnk, ~minpack.lm::nlsLM(mumax~joehnk_2008(temp = Growth_temperature, rmax, topt, a, b , c),
                     data = .x,
                     start = .y,
                     lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008'),
                     upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008'),
                     weights = 1/sd_mumax)))

#Create empty list column for each model
TPC.thomas2017 <- mutate(TPC.thomas2017, bootstrap = list(rep(NA, n())))

for(i in 1:nrow(TPC.thomas2017)){
  temp_data <- TPC.thomas2017$data[[i]]
  temp_fit <- nlsLM(mumax ~ thomas_2017(temp = Growth_temperature, a, b, c, d, e),
               data = temp_data,
               start = TPC.thomas2017$coefs_thomas2017[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'thomas_2017'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'thomas_2017'))
  boot <- Boot(temp_fit, method = 'residual')
  TPC.thomas2017$bootstrap[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

TPC.kamykowski <- mutate(TPC.kamykowski, bootstrap = list(rep(NA, n())))

for(i in 1:nrow(TPC.kamykowski)){
  temp_data <- TPC.kamykowski$data[[i]]
  temp_fit <- nlsLM(mumax ~ kamykowski_1985(Growth_temperature, tmin, tmax, a, b, c),
               data = temp_data,
               start = TPC.kamykowski$coefs_kamykowski[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'kamykowski_1985'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'kamykowski_1985'))
  boot <- Boot(temp_fit, method = 'residual')
  TPC.kamykowski$bootstrap[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

TPC.joehnk <- mutate(TPC.joehnk, bootstrap = list(rep(NA, n())))

for(i in 1:nrow(TPC.joehnk)){
  temp_data <- TPC.joehnk$data[[i]]
  temp_fit <- nlsLM(mumax ~ joehnk_2008(Growth_temperature, rmax, topt, a, b , c),
               data = temp_data,
               start = TPC.joehnk$coefs_joehnk[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'joehnk_2008'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'joehnk_2008'))
  boot <- Boot(temp_fit, method = 'residual')
  TPC.joehnk$bootstrap[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

#Get the raw values of each bootstrap for each model
TPC.thomas2017 <- mutate(TPC.thomas2017, output_boot = map(bootstrap, function(x) x$t))
TPC.kamykowski <- mutate(TPC.kamykowski, output_boot = map(bootstrap, function(x) x$t))
TPC.joehnk <- mutate(TPC.joehnk, output_boot = map(bootstrap, function(x) x$t))

TPC.thomas2017 <- mutate(TPC.thomas2017, preds = map2(output_boot, data, function(x, y){
  Growth_temperature <- as.data.frame(x) %>%
    drop_na() %>%
    mutate(iter = 1:n()) %>%
    group_by_all() %>%
    do(data.frame(Growth_temperature = seq(min(y$Growth_temperature), max(y$Growth_temperature), length.out = 100))) %>%
    ungroup() %>%
    mutate(pred = thomas_2017(temp = Growth_temperature, a, b, c, d, e))
  return(Growth_temperature)
}))

TPC.kamykowski <- mutate(TPC.kamykowski, preds = map2(output_boot, data, function(x, y){
  Growth_temperature <- as.data.frame(x) %>%
    drop_na() %>%
    mutate(iter = 1:n()) %>%
    group_by_all() %>%
    do(data.frame(Growth_temperature = seq(min(y$Growth_temperature), max(y$Growth_temperature), length.out = 100))) %>%
    ungroup() %>%
    mutate(pred = kamykowski_1985(Growth_temperature, tmin, tmax, a, b, c))
  return(Growth_temperature)
}))

TPC.joehnk <- mutate(TPC.joehnk, preds = map2(output_boot, data, function(x, y){
  Growth_temperature <- as.data.frame(x) %>%
    drop_na() %>%
    mutate(iter = 1:n()) %>%
    group_by_all() %>%
    do(data.frame(Growth_temperature = seq(min(y$Growth_temperature), max(y$Growth_temperature), length.out = 100))) %>%
    ungroup() %>%
    mutate(pred = joehnk_2008(Growth_temperature, rmax, topt, a, b , c))
  return(Growth_temperature)
}))

#Calculate bootstrapped confidence intervals
TPC.thomas2017_preds_CI <- select(TPC.thomas2017, Lineage, preds) %>%
  unnest(preds) %>%
  group_by(Lineage, Growth_temperature) %>%
  summarise(conf_lower = quantile(pred, 0.025),
            conf_upper = quantile(pred, 0.975),
            .groups = 'drop') %>%
  mutate(model_name = 'thomas2017')

TPC.kamykowski_preds_CI <- select(TPC.kamykowski, Lineage, preds) %>%
  unnest(preds) %>%
  group_by(Lineage, Growth_temperature) %>%
  summarise(conf_lower = quantile(pred, 0.025),
            conf_upper = quantile(pred, 0.975),
            .groups = 'drop') %>%
  mutate(model_name = 'kamykowski')

TPC.joehnk_preds_CI <- select(TPC.joehnk, Lineage, preds) %>%
  unnest(preds) %>%
  group_by(Lineage, Growth_temperature) %>%
  summarise(conf_lower = quantile(pred, 0.025),
            conf_upper = quantile(pred, 0.975),
            .groups = 'drop') %>%
  mutate(model_name = 'joehnk')

TPC.preds_CI <- rbind(TPC.thomas2017_preds_CI, TPC.kamykowski_preds_CI, TPC.joehnk_preds_CI)

TPC.preds_CI_low <- left_join(TPC.preds, dplyr::select(TPC.model_weights, Lineage, model_name, weight)) %>%
  select(-Replicate, -.fitted) %>%
  ungroup() %>%
  left_join(dplyr::select(TPC.preds_CI, Lineage, model_name, Growth_temperature, conf_lower),
            by = c('Lineage', 'model_name', 'Growth_temperature')) %>%
  na.omit() %>%
  group_by(Lineage, Growth_temperature) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = weight+(weight_dif/2)) %>% #Adjust model weight since kamykowski CIs not obtained for some TP4 lineages
  select(-weight_dif) %>%
  summarise(., conf_lower = sum(conf_lower*weight)) %>%
  ungroup()

TPC.preds_CI_up <- left_join(TPC.preds, dplyr::select(TPC.model_weights, Lineage, model_name, weight)) %>%
  select(-Replicate, -.fitted) %>%
  ungroup() %>%
  left_join(dplyr::select(TPC.preds_CI, Lineage, model_name, Growth_temperature, conf_upper),
            by = c('Lineage', 'model_name', 'Growth_temperature')) %>%
  na.omit() %>%
  group_by(Lineage, Growth_temperature) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = weight+(weight_dif/2)) %>% #Adjust model weight since kamykowski CIs not obtained for some TP4 lineages
  select(-weight_dif) %>%
  summarise(., conf_upper = sum(conf_upper*weight)) %>%
  ungroup()

TPC.ave_preds_CI <- left_join(TPC.preds_CI_low, TPC.preds_CI_up, by = c('Lineage', 'Growth_temperature')) %>%
  mutate(EE_treatment = case_when(str_detect(Lineage, 'TP1') ~ 'TP1',
                                  str_detect(Lineage, 'TP2') ~ 'TP2',
                                  str_detect(Lineage, 'TP3') ~ 'TP3',
                                  str_detect(Lineage, 'TP4') ~ 'TP4',
                                  str_detect(Lineage, 'TP5') ~ 'TP5')) %>%
  mutate(Replicate = case_when(str_detect(Lineage, "_1") ~ '1',
                               str_detect(Lineage, "_2") ~ '2',
                               str_detect(Lineage, "_3") ~ '3',
                               str_detect(Lineage, "_4") ~ '4',
                               str_detect(Lineage, "_5") ~ '5',
                               str_detect(Lineage, "_6") ~ '6',
                               TRUE ~ 'Error')) %>%
  select(EE_treatment, Lineage, Replicate, Growth_temperature, conf_lower, conf_upper)

#Plot bootstrapped CIs
TPC.CI.plot <- TPC.preds_ave %>%
  group_by(EE_treatment, Growth_temperature) %>%
  ggplot(aes()) +
  geom_point(aes(Growth_temperature, mumax, group = interaction(Lineage, Replicate)), TPC.df2, size = 1.5, pch = 20, shape = 0) +
  geom_line(aes(Growth_temperature, .fitted, colour = EE_treatment)) +
  geom_ribbon(aes(Growth_temperature, ymin = conf_lower, ymax = conf_upper, fill = EE_treatment, group = interaction(Lineage, Replicate)),
              TPC.ave_preds_CI, alpha = 0.3) +
  #facet_wrap(.~Lineage, ncol = 6) +
  facet_grid(EE_treatment~Replicate, labeller = labeller(EE_treatment = treatment.labs)) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  theme_bw() +
  scale_x_continuous('Temperature (ºC)', breaks= seq(20, 32, by = 4), expand =c(0,0), limits = c(20,32)) +
  scale_y_continuous(expression(bold(Maximum~growth~rate~(d^-1))), limits = c(NA,NA)) +
  scale_colour_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  labs(colour = 'Experimental evolution treatment') +
  theme(panel.grid.minor = element_blank(),
        strip.text.x=element_text(size = 14, face="bold"),
        strip.text.y=element_text(size = 14, face="bold"),
        panel.spacing.x = unit(1, "lines"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "top",
        title = element_text(size = 14, face = "bold"),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  guides(fill = F)
TPC.CI.plot
``` 

## Obtain confidence intervals for parameters
```{r}
#Get coefs for the models that were selected for averaging
TPC.thomas2017 <- mutate(TPC.thomas2017, ci_extra_params = list(rep(NA, n())))
TPC.kamykowski <- mutate(TPC.kamykowski, ci_extra_params = list(rep(NA, n()))) %>%
  filter(Lineage != 'TP3_6')
TPC.joehnk <- mutate(TPC.joehnk, ci_extra_params = list(rep(NA, n())))

#Run for loop to bootstrap extra params from each model
for(i in 1:nrow(TPC.thomas2017)){
  temp_data <- TPC.thomas2017$data[[i]]
  temp_fit <- nlsLM(mumax ~ thomas_2017(temp = Growth_temperature, a, b, c, d, e),
               data = temp_data,
               start = TPC.thomas2017$coefs_thomas2017[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'thomas_2017'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'thomas_2017'))
  boot <- Boot(temp_fit, f = function(x){unlist(calc_params(x))}, labels = names(calc_params(temp_fit)),
               R = 20, method = 'residual') %>%
  confint(., method = 'bca') %>%
  as.data.frame() %>%
  rename(conf_lower = 1, conf_upper = 2) %>%
  rownames_to_column(., var = 'param')
  TPC.thomas2017$ci_extra_params[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

for(i in 1:nrow(TPC.kamykowski)){
  temp_data <- TPC.kamykowski$data[[i]]
  temp_fit <- nlsLM(mumax ~ kamykowski_1985(temp = Growth_temperature, tmin, tmax, a, b, c),
               data = temp_data,
               start = TPC.kamykowski$coefs_kamykowski[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'kamykowski_1985'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'kamykowski_1985'))
  boot <- Boot(temp_fit, f = function(x){unlist(calc_params(x))}, labels = names(calc_params(temp_fit)),
               R = 20, method = 'residual') %>%
  confint(., method = 'bca') %>%
  as.data.frame() %>%
  rename(conf_lower = 1, conf_upper = 2) %>%
  rownames_to_column(., var = 'param')
  TPC.kamykowski$ci_extra_params[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

for(i in 1:nrow(TPC.joehnk)){
  temp_data <- TPC.joehnk$data[[i]]
  temp_fit <- nlsLM(mumax ~ joehnk_2008(Growth_temperature, rmax, topt, a, b , c),
               data = temp_data,
               start = TPC.joehnk$coefs_joehnk[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'joehnk_2008'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'joehnk_2008'))
  boot <- Boot(temp_fit, f = function(x){unlist(calc_params(x))}, labels = names(calc_params(temp_fit)),
               R = 20, method = 'residual') %>%
  confint(., method = 'bca') %>%
  as.data.frame() %>%
  rename(conf_lower = 1, conf_upper = 2) %>%
  rownames_to_column(., var = 'param')
  TPC.joehnk$ci_extra_params[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

#Calculate extra params for each model and put in long format to begin with
TPC.thomas2017 <- mutate(TPC.thomas2017, extra_params = map(TPC.nlsLM_thomas2017, function(x){calc_params(x) %>%
    pivot_longer(everything(), names_to =  'param', values_to = 'estimate')}))

TPC.thomas2017_param_CI <- left_join(select(TPC.thomas2017, Lineage, extra_params) %>%  unnest(extra_params),
                                     select(TPC.thomas2017, Lineage, ci_extra_params) %>% unnest(ci_extra_params)) %>%
  mutate(model_name = 'thomas2017')

TPC.kamykowski <- mutate(TPC.kamykowski, extra_params = map(TPC.nlsLM_kamykowski, function(x){calc_params(x) %>%
    pivot_longer(everything(), names_to =  'param', values_to = 'estimate')}))

TPC.kamykowski_param_CI <- left_join(select(TPC.kamykowski, Lineage, extra_params) %>% unnest(extra_params),
                                     select(TPC.kamykowski, Lineage, ci_extra_params) %>% unnest(ci_extra_params)) %>%
  mutate(model_name = 'kamykowski')

TPC.joehnk <- mutate(TPC.joehnk, extra_params = map(TPC.nlsLM_joehnk, function(x){calc_params(x) %>%
    pivot_longer(everything(), names_to =  'param', values_to = 'estimate')}))

TPC.joehnk_param_CI <- left_join(select(TPC.joehnk, Lineage, extra_params) %>% unnest(extra_params),
                                  select(TPC.joehnk, Lineage, ci_extra_params) %>% unnest(ci_extra_params)) %>%
  mutate(model_name = 'joehnk')


TPC.param_CI <- rbind(TPC.thomas2017_param_CI, TPC.kamykowski_param_CI, TPC.joehnk_param_CI)
  
TPC.param_CI_low <- left_join(TPC.param_CI, dplyr::select(TPC.model_weights, Lineage, model_name, weight)) %>%
  select(-estimate, -conf_upper) %>%
  na.omit() %>%
  ungroup() %>%
  group_by(Lineage, param) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = case_when(str_detect(Lineage, 'TP3_6') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_1') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_2') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_3') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_5') ~ weight+(weight_dif/2),
                            TRUE ~ weight)) %>%
  select(-weight_dif) %>%
  summarise(., conf_lower = sum(conf_lower*weight)) %>%
  ungroup()

TPC.param_CI_up <- left_join(TPC.param_CI, dplyr::select(TPC.model_weights, Lineage, model_name, weight)) %>%
  select(-estimate, -conf_lower) %>%
  na.omit() %>%
  ungroup() %>%
  group_by(Lineage, param) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = case_when(str_detect(Lineage, 'TP3_6') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_1') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_2') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_3') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_5') ~ weight+(weight_dif/2),
                            TRUE ~ weight)) %>%
  select(-weight_dif) %>%
  summarise(., conf_upper = sum(conf_upper*weight)) %>%
  ungroup()

TPC.param_CI_est <- left_join(TPC.param_CI, dplyr::select(TPC.model_weights, Lineage, model_name, weight)) %>%
  select(-conf_lower, -conf_upper) %>%
  na.omit() %>%
  ungroup() %>%
  filter(!(Lineage == 'TP1_2' & model_name == 'thomas2017')) %>%
  filter(!(Lineage == 'TP1_2' & model_name == 'joehnk')) %>%
  group_by(Lineage, param) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = case_when(str_detect(Lineage, 'TP1_2') ~ weight+weight_dif,
                            str_detect(Lineage, 'TP3_6') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_1') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_2') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_3') ~ weight+(weight_dif/2),
                            str_detect(Lineage, 'TP4_5') ~ weight+(weight_dif/2),
                            TRUE ~ weight)) %>%
  select(-weight_dif) %>%
  summarise(., estimate = sum(estimate*weight)) %>%
  ungroup()

TPC.param_CI_ave <- left_join(TPC.param_CI_low, TPC.param_CI_up, by = c('Lineage', 'param')) %>%
  left_join(TPC.param_CI_est, by = c('Lineage', 'param')) %>%
  mutate(EE_treatment = case_when(str_detect(Lineage, 'TP1') ~ 'TP1',
                                  str_detect(Lineage, 'TP2') ~ 'TP2',
                                  str_detect(Lineage, 'TP3') ~ 'TP3',
                                  str_detect(Lineage, 'TP4') ~ 'TP4',
                                  str_detect(Lineage, 'TP5') ~ 'TP5')) %>%
  mutate(Replicate = case_when(str_detect(Lineage, "_1") ~ '1',
                               str_detect(Lineage, "_2") ~ '2',
                               str_detect(Lineage, "_3") ~ '3',
                               str_detect(Lineage, "_4") ~ '4',
                               str_detect(Lineage, "_5") ~ '5',
                               str_detect(Lineage, "_6") ~ '6',
                               TRUE ~ 'Error')) %>%
  select(EE_treatment, Lineage, Replicate, param, conf_lower, conf_upper, estimate) %>%
  group_by(EE_treatment, param) %>%
  mutate(med_conf_lower = median(conf_lower)) %>%
  mutate(med_conf_upper = median(conf_upper)) %>%
  mutate(med_estimate = median(estimate)) %>%
  mutate(param = case_when(str_detect(param, 'ctmax') ~ 'CTmax',
                           str_detect(param, 'ctmin') ~ 'CTmin',
                           str_detect(param, 'topt') ~ 'Topt',
                           str_detect(param, 'thermal_safety_margin') ~ 'TSM',
                           str_detect(param, 'breadth') ~ 'Tbr',
                           str_detect(param, 'rmax') ~ 'rmax',
                           TRUE ~ 'ERROR')) %>%
  filter(param %in% c('CTmax', 'CTmin', 'Topt', 'rmax', 'TSM', 'Tbr')) %>%
  mutate(param = factor(param, levels = c('Topt', 'CTmax', 'Tbr', 'TSM', 'CTmin', 'rmax')))

#Plot CIs for each parameter
param_labels <- as_labeller(c(Topt = "bold(T[opt]~(degree*C))",
                              CTmax = "bold(CT[max]~(degree*C))",
                              Tbr = "bold(T[br]~(degree*C))",
                              TSM = "bold(TSM ~(degree*C))",
                              CTmin = "bold(CT[min]~(degree*C))",
                              rmax = "bold(r[max] ~(day^-1))"),
                            default = label_parsed)

TPC.param_CI.plot <- TPC.param_CI_ave %>%
  mutate(param = factor(param, levels = c('Topt', 'CTmax', 'Tbr', 'TSM', 'CTmin', 'rmax'))) %>%
  ggplot(aes(colour = EE_treatment, fill = EE_treatment)) +
  geom_point(aes(x = Lineage, y = estimate, shape = Replicate), size = 1.5) +
  geom_linerange(aes(x = Lineage, ymin = conf_lower, ymax = conf_upper)) +
  scale_shape_manual(values = c(0,1,2,6,5,7), guide = guide_legend(title.position="top", nrow = 1)) +
  scale_colour_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB"),
                      guide = guide_legend(title.position="top", nrow = 1)) +
  scale_fill_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  facet_wrap(~param, ncol = 2, scales = 'free', labeller = param_labels) +
  #coord_flip() +
  labs(x = 'Lineage', y = 'Parameter estimate', colour = 'Experimental evolution treatment', shape = 'Replicate n°') +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        strip.text.x = element_text(size=14, face="bold"),
        strip.text.y = element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "top", 
        legend.direction = "horizontal",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_blank(), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  guides(fill = FALSE)
TPC.param_CI.plot
```                 

## Repeat for treatment level TPC predictions, parameter estimates & CIs
```{r}
TPC.EE_fits <- TPC.df %>%
  dplyr::select(-ave_mumax, -Lineage) %>%
  group_by(EE_treatment) %>%
  nest(data = c(Growth_temperature, mumax, sd_mumax)) %>%
  mutate(thomas2017 = map(data, ~nls_multstart(mumax~thomas_2017(temp = Growth_temperature, a, b, c, d, e),
                        data = .x,
                        iter = c(4,4,4,4,4),
                        start_lower = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017') - 1,
                        start_upper = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017') + 1,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017'),
                        supp_errors = 'Y',
                        convergence_count = FALSE),
                        modelweights = 1/sd_mumax),
         kamykowski = map(data, ~nls_multstart(mumax~kamykowski_1985(temp = Growth_temperature, tmin, tmax, a, b, c),
                        data = .x,
                        iter = c(4,4,4,4,4),
                        start_lower = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985') - 1,
                        start_upper = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985') + 1,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985'),
                        supp_errors = 'Y',
                        convergence_count = FALSE),
                        modelweights = 1/sd_mumax),
         joehnk = map(data, ~nls_multstart(mumax~joehnk_2008(temp = Growth_temperature, rmax, topt, a, b , c),
                        data = .x,
                        iter = c(4,4,4,4,4),
                        start_lower = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008') - 1,
                        start_upper = get_start_vals(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008') + 1,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008'),
                        supp_errors = 'Y',
                        convergence_count = FALSE),
                        modelweights = 1/sd_mumax))

#Stack models
TPC.EE_stack <- dplyr::select(TPC.EE_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', thomas2017:joehnk)

#Calculate measures of relative model fit (AIC, BIC, AICc)
TPC.EE_model_ic<- TPC.EE_stack %>%
  mutate(., info = map(fit, glance),
         AICc =  map_dbl(fit, MuMIn::AICc)) %>%
  #dplyr::select(-fit) %>%
  unnest(info) %>%
  dplyr::select(model_name, fit, sigma, AIC, AICc, BIC, df.residual)

#Calculate model weights
TPC.EE_model_weights <- TPC.EE_model_ic %>%
  group_by(EE_treatment) %>%
  mutate(., weight = MuMIn::Weights(AICc))

#Get predictions using augment
TPC.EE_newdata <- tibble(Growth_temperature = seq(min(TPC.df$Growth_temperature), max(TPC.df$Growth_temperature), length.out = 100))
TPC.EE_preds <- TPC.EE_stack %>%
  mutate(., rate_preds = map(fit, augment, newdata = TPC.EE_newdata)) %>%
  dplyr::select(-fit) %>%
  unnest(rate_preds)

#Get model average predictions (weighted)
TPC.EE_ave_preds <- left_join(TPC.EE_preds, dplyr::select(TPC.EE_model_weights, EE_treatment, model_name, weight)) %>%
  filter(EE_treatment != 'TP4' | model_name != 'kamykowski') %>%
  group_by(EE_treatment, Growth_temperature) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = weight+(weight_dif/2)) %>% #Adjust model weight since kamykowski CIs not obtained for TP4
  select(-weight_dif) %>%
  summarise(., .fitted = sum(.fitted*weight)) %>%
  ungroup()

#Calculate extra parameters from models
TPC.EE_extra_params <- TPC.EE_stack %>%
  mutate(., params = map(fit, calc_params)) %>%
  dplyr::select(-fit) %>%
  unnest(params)

#Get model average of each estimate 
TPC.EE_extra_params_ave <- left_join(TPC.EE_extra_params, TPC.EE_model_weights) %>%
  dplyr::select(!c(e, eh, q10, skewness, sigma, AIC, AICc, BIC, df.residual, fit)) %>%
  filter(!(EE_treatment %in% 'TP1' & model_name %in% c('joehnk', 'thomas2017'))) %>% #Remove these models due to CTmin being -inf
  mutate(weight = case_when(str_detect(EE_treatment, 'TP1') ~ 1, #Adjust model weight since only kamykowski remains
                            .default = as.numeric(weight))) %>%
  group_by(EE_treatment) %>%
  summarise(., across(rmax:breadth, function(x){sum(x*weight)})) %>%
  mutate(model_name = 'model average') %>%
  select(EE_treatment, model_name, ctmax, ctmin, topt, rmax, thermal_safety_margin, breadth) %>%
  pivot_longer(cols = ctmax:breadth, names_to = 'param', values_to = 'estimate') %>%
  group_by(EE_treatment, param) %>%
  mutate(med_estimate = median(estimate)) %>%
  mutate(param = case_when(str_detect(param, 'ctmax') ~ 'CTmax',
                           str_detect(param, 'ctmin') ~ 'CTmin',
                           str_detect(param, 'topt') ~ 'Topt',
                           str_detect(param, 'thermal_safety_margin') ~ 'TSM',
                           str_detect(param, 'breadth') ~ 'Tbr',
                           str_detect(param, 'rmax') ~ 'rmax',
                           TRUE ~ 'ERROR')) %>%
  mutate(EE_treatment = case_when(str_detect(EE_treatment, 'TP1') ~ 'Fluc-short',
                                  str_detect(EE_treatment, 'TP2') ~ 'Fluc-med',
                                  str_detect(EE_treatment, 'TP3') ~ 'Fluc-long',
                                  str_detect(EE_treatment, 'TP4') ~ 'Cont-ele',
                                  str_detect(EE_treatment, 'TP5') ~ 'Cont-amb',
                                  TRUE ~ 'ERROR'))

#Get coefs for the models that were selected for averaging
TPC.EE_thomas2017 <- TPC.EE_fits %>%
  select(EE_treatment, data, thomas2017) %>%
  mutate(., coefs_thomas2017 = map(thomas2017, coef))

TPC.EE_kamykowski <- TPC.EE_fits %>%
  select(EE_treatment, data, kamykowski) %>%
  mutate(., coefs_kamykowski = map(kamykowski, coef)) %>%
  filter(EE_treatment != 'TP4')

TPC.EE_joehnk <- TPC.EE_fits %>%
  select(EE_treatment, data, joehnk) %>%
  mutate(., coefs_joehnk = map(joehnk, coef))

#Refit each model using nlsLM
TPC.EE_thomas2017 <- mutate(TPC.EE_thomas2017, TPC.nlsLM_EE_thomas2017 = 
                        map2(data, coefs_thomas2017, ~minpack.lm::nlsLM(mumax~thomas_2017(temp = Growth_temperature, a, b, c, d, e),
                        data = .x,
                        start = .y,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'thomas_2017'),
                        weights = 1/sd_mumax)))

TPC.EE_kamykowski <- mutate(TPC.EE_kamykowski, TPC.nlsLM_EE_kamykowski = 
                        map2(data, coefs_kamykowski, ~minpack.lm::nlsLM(mumax~kamykowski_1985(temp = Growth_temperature, tmin, tmax, a, b, c),
                        data = .x,
                        start = .y,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'kamykowski_1985'),
                        weights = 1/sd_mumax)))

TPC.EE_joehnk <- mutate(TPC.EE_joehnk, TPC.nlsLM_EE_joehnk =
                        map2(data, coefs_joehnk, ~minpack.lm::nlsLM(mumax~joehnk_2008(temp = Growth_temperature, rmax, topt, a, b , c),
                        data = .x,
                        start = .y,
                        lower = get_lower_lims(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008'),
                        upper = get_upper_lims(.x$Growth_temperature, .x$mumax, model_name = 'joehnk_2008'),
                        weights = 1/sd_mumax)))

#Create empty list column for each model
TPC.EE_thomas2017 <- mutate(TPC.EE_thomas2017, bootstrap = list(rep(NA, n())))

for(i in 1:nrow(TPC.EE_thomas2017)){
  temp_data <- TPC.EE_thomas2017$data[[i]]
  temp_fit <- nlsLM(mumax ~ thomas_2017(temp = Growth_temperature, a, b, c, d, e),
               data = temp_data,
               start = TPC.EE_thomas2017$coefs_thomas2017[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'thomas_2017'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'thomas_2017'))
  boot <- Boot(temp_fit, method = 'residual')
  TPC.EE_thomas2017$bootstrap[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

TPC.EE_kamykowski <- mutate(TPC.EE_kamykowski, bootstrap = list(rep(NA, n())))

for(i in 1:nrow(TPC.EE_kamykowski)){
  temp_data <- TPC.EE_kamykowski$data[[i]]
  temp_fit <- nlsLM(mumax ~ kamykowski_1985(Growth_temperature, tmin, tmax, a, b, c),
               data = temp_data,
               start = TPC.EE_kamykowski$coefs_kamykowski[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'kamykowski_1985'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'kamykowski_1985'))
  boot <- Boot(temp_fit, method = 'residual')
  TPC.EE_kamykowski$bootstrap[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

TPC.EE_joehnk <- mutate(TPC.EE_joehnk, bootstrap = list(rep(NA, n())))

for(i in 1:nrow(TPC.EE_joehnk)){
  temp_data <- TPC.EE_joehnk$data[[i]]
  temp_fit <- nlsLM(mumax ~ joehnk_2008(Growth_temperature, rmax, topt, a, b , c),
               data = temp_data,
               start = TPC.EE_joehnk$coefs_joehnk[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'joehnk_2008'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'joehnk_2008'))
  boot <- Boot(temp_fit, method = 'residual')
  TPC.EE_joehnk$bootstrap[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

#Get the raw values of each bootstrap for each model
TPC.EE_thomas2017 <- mutate(TPC.EE_thomas2017, output_boot = map(bootstrap, function(x) x$t))
TPC.EE_kamykowski <- mutate(TPC.EE_kamykowski, output_boot = map(bootstrap, function(x) x$t))
TPC.EE_joehnk <- mutate(TPC.EE_joehnk, output_boot = map(bootstrap, function(x) x$t))

TPC.EE_thomas2017 <- mutate(TPC.EE_thomas2017, preds = map2(output_boot, data, function(x, y){
  Growth_temperature <- as.data.frame(x) %>%
    drop_na() %>%
    mutate(iter = 1:n()) %>%
    group_by_all() %>%
    do(data.frame(Growth_temperature = seq(min(y$Growth_temperature), max(y$Growth_temperature), length.out = 100))) %>%
    ungroup() %>%
    mutate(pred = thomas_2017(temp = Growth_temperature, a, b, c, d, e))
  return(Growth_temperature)
}))

TPC.EE_kamykowski <- mutate(TPC.EE_kamykowski, preds = map2(output_boot, data, function(x, y){
  Growth_temperature <- as.data.frame(x) %>%
    drop_na() %>%
    mutate(iter = 1:n()) %>%
    group_by_all() %>%
    do(data.frame(Growth_temperature = seq(min(y$Growth_temperature), max(y$Growth_temperature), length.out = 100))) %>%
    ungroup() %>%
    mutate(pred = kamykowski_1985(Growth_temperature, tmin, tmax, a, b, c))
  return(Growth_temperature)
}))

TPC.EE_joehnk <- mutate(TPC.EE_joehnk, preds = map2(output_boot, data, function(x, y){
  Growth_temperature <- as.data.frame(x) %>%
    drop_na() %>%
    mutate(iter = 1:n()) %>%
    group_by_all() %>%
    do(data.frame(Growth_temperature = seq(min(y$Growth_temperature), max(y$Growth_temperature), length.out = 100))) %>%
    ungroup() %>%
    mutate(pred = joehnk_2008(Growth_temperature, rmax, topt, a, b , c))
  return(Growth_temperature)
}))

#Calculate bootstrapped confidence intervals
TPC.EE_thomas2017_preds_CI <- select(TPC.EE_thomas2017, EE_treatment, preds) %>%
  unnest(preds) %>%
  group_by(EE_treatment, Growth_temperature) %>%
  summarise(conf_lower = quantile(pred, 0.025),
            conf_upper = quantile(pred, 0.975),
            .groups = 'drop') %>%
  mutate(model_name = 'thomas2017')

TPC.EE_kamykowski_preds_CI <- select(TPC.EE_kamykowski, EE_treatment, preds) %>%
  unnest(preds) %>%
  group_by(EE_treatment, Growth_temperature) %>%
  summarise(conf_lower = quantile(pred, 0.025),
            conf_upper = quantile(pred, 0.975),
            .groups = 'drop') %>%
  mutate(model_name = 'kamykowski')

TPC.EE_joehnk_preds_CI <- select(TPC.EE_joehnk, EE_treatment, preds) %>%
  unnest(preds) %>%
  group_by(EE_treatment, Growth_temperature) %>%
  summarise(conf_lower = quantile(pred, 0.025),
            conf_upper = quantile(pred, 0.975),
            .groups = 'drop') %>%
  mutate(model_name = 'joehnk')

TPC.EE_preds_CI <- rbind(TPC.EE_thomas2017_preds_CI, TPC.EE_kamykowski_preds_CI, TPC.EE_joehnk_preds_CI)

TPC.EE_preds_CI_low <- left_join(TPC.EE_preds, dplyr::select(TPC.EE_model_weights, model_name, weight)) %>%
  select(-.fitted) %>%
  ungroup() %>%
  left_join(dplyr::select(TPC.EE_preds_CI, EE_treatment, model_name, Growth_temperature, conf_lower),
            by = c('EE_treatment', 'model_name', 'Growth_temperature')) %>%
  na.omit() %>%
  group_by(EE_treatment, Growth_temperature) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = weight+(weight_dif/2)) %>% #Adjust model weight since kamykowski CIs not obtained for TP4
  select(-weight_dif) %>%
  summarise(., conf_lower = sum(conf_lower*weight)) %>%
  ungroup()

TPC.EE_preds_CI_up <- left_join(TPC.EE_preds, dplyr::select(TPC.EE_model_weights, model_name, weight)) %>%
  select(-.fitted) %>%
  ungroup() %>%
  left_join(dplyr::select(TPC.EE_preds_CI, EE_treatment, model_name, Growth_temperature, conf_upper),
            by = c('EE_treatment', 'model_name', 'Growth_temperature')) %>%
  na.omit() %>%
  group_by(EE_treatment, Growth_temperature) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = weight+(weight_dif/2)) %>% #Adjust model weight since kamykowski CIs not obtained for TP4
  select(-weight_dif) %>%
  summarise(., conf_upper = sum(conf_upper*weight)) %>%
  ungroup()

TPC.EE_preds_CI <- left_join(TPC.EE_preds_CI_low, TPC.EE_preds_CI_up, by = c('EE_treatment', 'Growth_temperature'))

#Plot bootstrapped CIs
TPC.EE_CI.plot <- TPC.EE_ave_preds %>%
  group_by(EE_treatment, Growth_temperature) %>%
  ggplot(aes()) +
  geom_point(aes(Growth_temperature, mumax, colour = EE_treatment), TPC.df2, size = 1.5, pch = 20, shape = 0) +
  geom_line(aes(Growth_temperature, .fitted, colour = EE_treatment)) +
  geom_ribbon(aes(Growth_temperature, ymin = conf_lower, ymax = conf_upper, fill = EE_treatment), TPC.EE_preds_CI, alpha = 0.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  theme_bw() +
  scale_x_continuous('Temperature (ºC)', breaks= seq(20, 32, by = 4), expand =c(0,0), limits = c(20,32)) +
  scale_y_continuous(expression(bold(Maximum~growth~rate~(d^-1))), limits = c(NA,NA)) +
  scale_colour_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  labs(colour = 'Experimental evolution treatment') +
  theme(panel.grid.minor = element_blank(),
        strip.text.x=element_text(size = 14, face="bold"),
        strip.text.y=element_text(size = 14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "top",
        title = element_text(size = 14, face = "bold"),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  guides(fill = F)
TPC.EE_CI.plot

TPC.EE_CI.plot2 <- TPC.EE_CI.plot +
  facet_grid(.~EE_treatment, labeller = labeller(EE_treatment = treatment.labs))
TPC.EE_CI.plot2

#Prepare extra column for calculation of parameters
TPC.EE_thomas2017 <- mutate(TPC.EE_thomas2017, ci_extra_params = list(rep(NA, n())))
TPC.EE_kamykowski <- mutate(TPC.EE_kamykowski, ci_extra_params = list(rep(NA, n())))
TPC.EE_joehnk <- mutate(TPC.EE_joehnk, ci_extra_params = list(rep(NA, n())))

#Run for loop to bootstrap extra params from each model
for(i in 1:nrow(TPC.EE_thomas2017)){
  temp_data <- TPC.EE_thomas2017$data[[i]]
  temp_fit <- nlsLM(mumax ~ thomas_2017(temp = Growth_temperature, a, b, c, d, e),
               data = temp_data,
               start = TPC.EE_thomas2017$coefs_thomas2017[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'thomas_2017'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'thomas_2017'))
  boot <- Boot(temp_fit, f = function(x){unlist(calc_params(x))}, labels = names(calc_params(temp_fit)),
               R = 20, method = 'residual') %>%
  confint(., method = 'bca') %>%
  as.data.frame() %>%
  rename(conf_lower = 1, conf_upper = 2) %>%
  rownames_to_column(., var = 'param')
  TPC.EE_thomas2017$ci_extra_params[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

for(i in 1:nrow(TPC.EE_kamykowski)){
  temp_data <- TPC.EE_kamykowski$data[[i]]
  temp_fit <- nlsLM(mumax ~ kamykowski_1985(temp = Growth_temperature, tmin, tmax, a, b, c),
               data = temp_data,
               start = TPC.EE_kamykowski$coefs_kamykowski[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'kamykowski_1985'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'kamykowski_1985'))
  boot <- Boot(temp_fit, f = function(x){unlist(calc_params(x))}, labels = names(calc_params(temp_fit)),
               R = 20, method = 'residual') %>%
  confint(., method = 'bca') %>%
  as.data.frame() %>%
  rename(conf_lower = 1, conf_upper = 2) %>%
  rownames_to_column(., var = 'param')
  TPC.EE_kamykowski$ci_extra_params[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

for(i in 1:nrow(TPC.EE_joehnk)){
  temp_data <- TPC.EE_joehnk$data[[i]]
  temp_fit <- nlsLM(mumax ~ joehnk_2008(Growth_temperature, rmax, topt, a, b , c),
               data = temp_data,
               start = TPC.EE_joehnk$coefs_joehnk[[i]],
               lower = get_lower_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'joehnk_2008'),
               upper = get_upper_lims(temp_data$Growth_temperature, temp_data$mumax, model_name = 'joehnk_2008'))
  boot <- Boot(temp_fit, f = function(x){unlist(calc_params(x))}, labels = names(calc_params(temp_fit)),
               R = 20, method = 'residual') %>%
  confint(., method = 'bca') %>%
  as.data.frame() %>%
  rename(conf_lower = 1, conf_upper = 2) %>%
  rownames_to_column(., var = 'param')
  TPC.EE_joehnk$ci_extra_params[[i]] <- boot
  rm(list = c('temp_fit', 'temp_data', 'boot'))
}

#Calculate extra params for each model and put in long format to begin with
TPC.EE_thomas2017 <- mutate(TPC.EE_thomas2017, extra_params = map(TPC.nlsLM_EE_thomas2017, function(x){calc_params(x) %>%
    pivot_longer(everything(), names_to =  'param', values_to = 'estimate')}))

TPC.EE_thomas2017_param_CI <- left_join(select(TPC.EE_thomas2017, EE_treatment, extra_params) %>%  unnest(extra_params),
                                        select(TPC.EE_thomas2017, EE_treatment, ci_extra_params) %>% unnest(ci_extra_params)) %>%
  mutate(model_name = 'thomas2017')

TPC.EE_kamykowski <- mutate(TPC.EE_kamykowski, extra_params = map(TPC.nlsLM_EE_kamykowski, function(x){calc_params(x) %>%
    pivot_longer(everything(), names_to =  'param', values_to = 'estimate')}))

TPC.EE_kamykowski_param_CI <- left_join(select(TPC.EE_kamykowski, EE_treatment, extra_params) %>% unnest(extra_params),
                                        select(TPC.EE_kamykowski, EE_treatment, ci_extra_params) %>% unnest(ci_extra_params)) %>%
  mutate(model_name = 'kamykowski')

TPC.EE_joehnk <- mutate(TPC.EE_joehnk, extra_params = map(TPC.nlsLM_EE_joehnk, function(x){calc_params(x) %>%
    pivot_longer(everything(), names_to =  'param', values_to = 'estimate')}))

TPC.EE_joehnk_param_CI <- left_join(select(TPC.EE_joehnk, EE_treatment, extra_params) %>% unnest(extra_params),
                                    select(TPC.EE_joehnk, EE_treatment, ci_extra_params) %>% unnest(ci_extra_params)) %>%
  mutate(model_name = 'joehnk')


TPC.EE_param_CI <- rbind(TPC.EE_thomas2017_param_CI, TPC.EE_kamykowski_param_CI, TPC.EE_joehnk_param_CI)
  
TPC.EE_param_CI_low <- left_join(TPC.EE_param_CI, dplyr::select(TPC.EE_model_weights, EE_treatment, model_name, weight)) %>%
  select(-estimate, -conf_upper) %>%
  filter(param %in% c('ctmax', 'ctmin', 'topt', 'rmax', 'thermal_safety_margin', 'breadth')) %>%
  group_by(EE_treatment, param) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = case_when(str_detect(EE_treatment, 'TP4') ~ weight+(weight_dif/2),
                            TRUE ~ weight)) %>%
  select(-weight_dif) %>%
  summarise(., conf_lower = sum(conf_lower*weight)) %>%
  ungroup()

TPC.EE_param_CI_up <- left_join(TPC.EE_param_CI, dplyr::select(TPC.EE_model_weights, EE_treatment, model_name, weight)) %>%
  select(-estimate, -conf_lower) %>%
  filter(param %in% c('ctmax', 'ctmin', 'topt', 'rmax', 'thermal_safety_margin', 'breadth')) %>%
  group_by(EE_treatment, param) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = case_when(str_detect(EE_treatment, 'TP4') ~ weight+(weight_dif/2),
                            TRUE ~ weight)) %>%
  select(-weight_dif) %>%
  summarise(., conf_upper = sum(conf_upper*weight)) %>%
  ungroup()

TPC.EE_param_est <- left_join(TPC.EE_param_CI, dplyr::select(TPC.EE_model_weights, EE_treatment, model_name, weight)) %>%
  select(-conf_lower, -conf_upper) %>%
  filter(param %in% c('ctmax', 'ctmin', 'topt', 'rmax', 'thermal_safety_margin', 'breadth')) %>%
  group_by(EE_treatment, param) %>%
  mutate(weight_dif = 1-sum(weight)) %>%
  mutate(weight = case_when(str_detect(EE_treatment, 'TP4') ~ weight+(weight_dif/2),
                            TRUE ~ weight)) %>%
  select(-weight_dif) %>%
  summarise(., estimate = sum(estimate*weight)) %>%
  ungroup()

TPC.EE_param <- left_join(TPC.EE_param_CI_low, TPC.EE_param_CI_up, by = c('EE_treatment', 'param')) %>%
  left_join(TPC.EE_param_est, by = c('EE_treatment', 'param')) %>%
  mutate(param = case_when(str_detect(param, 'ctmax') ~ 'CTmax',
                           str_detect(param, 'ctmin') ~ 'CTmin',
                           str_detect(param, 'topt') ~ 'Topt',
                           str_detect(param, 'thermal_safety_margin') ~ 'TSM',
                           str_detect(param, 'breadth') ~ 'Tbr',
                           str_detect(param, 'rmax') ~ 'rmax',
                           TRUE ~ 'ERROR')) %>%
  mutate(EE_treatment = case_when(str_detect(EE_treatment, 'TP1') ~ 'Fluc-short',
                                  str_detect(EE_treatment, 'TP2') ~ 'Fluc-med',
                                  str_detect(EE_treatment, 'TP3') ~ 'Fluc-long',
                                  str_detect(EE_treatment, 'TP4') ~ 'Cont-ele',
                                  str_detect(EE_treatment, 'TP5') ~ 'Cont-amb',
                                  TRUE ~ 'ERROR'))

#Plot parameter estimates with CIs
filtered_data <- filter(TPC.EE_param, EE_treatment == 'Cont-amb') %>%
  mutate(param = factor(param, levels = c('Topt', 'CTmax', 'Tbr', 'TSM', 'CTmin', 'rmax')))

param_labels <- as_labeller(c(Topt = "bold(T[opt]~(degree*C))",
                              CTmax = "bold(CT[max]~(degree*C))",
                              Tbr = "bold(T[br]~(degree*C))",
                              TSM = "bold(TSM ~(degree*C))",
                              CTmin = "bold(CT[min]~(degree*C))",
                              rmax = "bold(r[max] ~(day^-1))"),
                            default = label_parsed)

TPC.EE_param.plot <- TPC.EE_param %>%
  mutate(param = factor(param, levels = c('Topt', 'CTmax', 'Tbr', 'TSM', 'CTmin', 'rmax'))) %>%
  ggplot(aes(colour = EE_treatment)) +
  geom_point(aes(EE_treatment, estimate), size = 1.5, pch = 20, shape = 0) +
  geom_hline(data = filtered_data, aes(yintercept = conf_upper), colour = 'black', size = 0.25, linetype = 'dashed') +
  geom_hline(data = filtered_data, aes(yintercept = conf_lower), colour = 'black', size = 0.25, linetype = 'dashed') +
  geom_linerange(aes(x = EE_treatment, ymin = conf_lower, ymax = conf_upper)) +
  scale_colour_manual(labels = treatment.labs, values=c("#BBBBBB","#0269A5", "#009988", "#DDAA33", "#CC3311")) +
  scale_fill_manual(labels = treatment.labs, values=c("#BBBBBB","#0269A5", "#009988", "#DDAA33", "#CC3311")) +
  facet_wrap(.~param, ncol = 2, scales = 'free', labeller = param_labels) +
  #coord_flip() +
  labs(x = 'Experimental evolution treatment', y = 'Parameter estimate', colour = 'Experimental evolution treatment') +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "top", 
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_blank(), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  guides(fill = FALSE)
TPC.EE_param.plot
```                 

## TPC visualisation
```{r}
#TPCs plot - by treatment (visualisation purposes)
TPC.treat_plot <- TPC.preds_ave %>%
  filter(model_name == 'model_average') %>%
  group_by(EE_treatment, Growth_temperature) %>%
  mutate(ave.fitted = mean(.fitted)) %>%
  mutate(sd.fitted = sd(.fitted)) %>%
  select(EE_treatment, Growth_temperature, ave.fitted, sd.fitted) %>%
  distinct() %>%
  ggplot(aes(x = Growth_temperature, y = ave.fitted, group = EE_treatment)) +
  geom_line(aes(colour = EE_treatment)) +
  geom_ribbon(aes(fill = EE_treatment, ymin = ave.fitted-sd.fitted, ymax = ave.fitted+sd.fitted), alpha = 0.25) +
  geom_point(aes(x = Growth_temperature, y = mumax, colour = EE_treatment), TPC.df, size = 1.5, pch = 20, shape = 0) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  scale_x_continuous('Temperature (ºC)', breaks= seq(20, 32, by = 3), expand =c(0,0), limits = c(20,32)) +
  scale_y_continuous(expression(bold(Maximum~growth~rate~(d^-1))), limits = c(NA,NA)) +
  scale_colour_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(labels = treatment.labs, values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  labs(colour = 'Experimental evolution treatment') +
  theme(panel.grid.minor = element_blank(),
        strip.text.x=element_text(size = 14, face="bold"),
        strip.text.y=element_text(size = 14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = "top",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black",  face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        guides(fill = FALSE)
TPC.treat_plot
```

## Test for significant differences between experimental evolution treatments
```{r}
#Check anova assumptions (QQplots to check for normal distribution)
aov.topt <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'Topt', ])
qqnorm(aov.topt$residuals) 
qqline(aov.topt$residuals)

aov.rmax <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'rmax', ])
qqnorm(aov.rmax$residuals) 
qqline(aov.rmax$residuals)

aov.ctmax <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'CTmax', ])
qqnorm(aov.ctmax$residuals) 
qqline(aov.ctmax$residuals)

aov.ctmin <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'CTmin', ])
qqnorm(aov.ctmin$residuals) 
qqline(aov.ctmin$residuals)

aov.tbr <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'Tbr', ])
qqnorm(aov.tbr$residuals) 
qqline(aov.tbr$residuals)

aov.tsm <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'TSM', ])
qqnorm(aov.tsm$residuals) 
qqline(aov.tsm$residuals)

#Check for significant differences between EE treatments for parameters of interest (using Tukey’s HSD)
tukey_hsd.topt <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'Topt', ]) %>%
  tukey_hsd() %>%
  filter(p.adj < 0.05)

tukey_hsd.rmax <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'rmax', ]) %>%
  tukey_hsd() %>%
  filter(p.adj < 0.05)

tukey_hsd.ctmax <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'CTmax', ]) %>%
  tukey_hsd() %>%
  filter(p.adj < 0.05)

tukey_hsd.ctmin <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'CTmin', ]) %>%
  tukey_hsd() %>%
  filter(p.adj < 0.05)

tukey_hsd.tbr <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'Tbr', ]) %>%
  tukey_hsd() %>%
  filter(p.adj < 0.05)

tukey_hsd.tsm <- aov(estimate ~ EE_treatment, data = TPC.extra_params_ave[TPC.extra_params_ave$param == 'TSM', ]) %>%
  tukey_hsd() %>%
  filter(p.adj < 0.05)
```

## Plots of parameters of interest
```{r}
Topt.plot <- TPC.extra_params_ave %>%
  filter(param == 'Topt') %>%
  ggplot() +
  geom_boxplot(aes(EE_treatment, y = estimate, fill = EE_treatment)) +
  stat_pvalue_manual(tukey_hsd.topt, label = "p.adj.signif", y.position = c(29.75, 29.95, 30.2, 30.2), tip.length = 0.01) +
  scale_y_continuous(expression(bold(T[opt]~(ºC))), expand =c(0,0), limits = c(25, 30.5)) +
  scale_x_discrete('Experimental evolution treatment', labels = treatment.labs) +
  scale_colour_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = 'top',
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        guides(fill = FALSE, colour = FALSE)
Topt.plot

rmax.plot <- TPC.extra_params_ave %>%
  filter(param == 'rmax') %>%
  ggplot() +
  geom_boxplot(aes(EE_treatment, y = estimate, fill = EE_treatment)) +
  stat_pvalue_manual(tukey_hsd.rmax, label = "p.adj.signif", y.position = c(0.149, 0.151, 0.153, 0.143, 0.145, 0.147),
                     tip.length = 0.01) +
  scale_y_continuous(expression(bold(r[max]~(day^-1))), expand =c(0,0), limits = c(0.1, 0.155)) +
  scale_x_discrete('Experimental evolution treatment', labels = treatment.labs) +
  scale_colour_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = 'top',
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        guides(fill = FALSE, colour = FALSE)
rmax.plot

CTmax.plot <- TPC.extra_params_ave %>%
  filter(param == 'CTmax') %>%
  ggplot() +
  geom_boxplot(aes(x = EE_treatment, y = estimate, fill = EE_treatment)) +
  stat_pvalue_manual(tukey_hsd.ctmax, label = "p.adj.signif", y.position = c(31.1, 31.15, 31, 31), tip.length = 0.01) +
  scale_y_continuous(expression(bold(CT[max]~(ºC))), expand =c(0,0), limits = c(30.2, 31.2)) +
  scale_x_discrete('Experimental evolution treatment', labels = treatment.labs) +
  scale_colour_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = 'top',
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        guides(fill = FALSE, colour = FALSE)
CTmax.plot

CTmin.plot <- TPC.extra_params_ave %>%
  filter(param == 'CTmin') %>%
  ggplot() +
  geom_boxplot(aes(EE_treatment, y = estimate, fill = EE_treatment)) +
  stat_pvalue_manual(tukey_hsd.ctmin, label = "p.adj.signif", y.position = c(21, 22.5, 23, 23.5, 22, 22, 21), tip.length = 0.01) +
  scale_y_continuous(expression(bold(CT[min]~(ºC))), expand =c(0,0), limits = c(12, 24)) +
  scale_x_discrete('Experimental evolution treatment', labels = treatment.labs) +
  scale_colour_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = 'top',
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        guides(fill = FALSE, colour = FALSE)
CTmin.plot

Tbr.plot <- TPC.extra_params_ave %>%
  filter(param == 'Tbr') %>%
  ggplot() +
  geom_boxplot(aes(EE_treatment, y = estimate, fill = EE_treatment)) +
  stat_pvalue_manual(tukey_hsd.tbr, label = "p.adj.signif", y.position = c(7, 7.2, 7.4, 7.6, 5.8, 5.8), tip.length = 0.01) +
  scale_y_continuous(expression(bold(T[br]~(ºC))), expand =c(0,0), limits = c(4, 8)) +
  scale_x_discrete('Experimental evolution treatment', labels = treatment.labs) +
  scale_colour_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = 'top',
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        guides(fill = FALSE, colour = FALSE)
Tbr.plot

TSM.plot <- TPC.extra_params_ave %>%
  filter(param == 'TSM') %>%
  ggplot() +
  stat_pvalue_manual(tukey_hsd.tsm, label = "p.adj.signif", y.position = c(6.05, 5.85, 5.65, 5.4, 5.2), tip.length = 0.01) +
  geom_boxplot(aes(EE_treatment, y = estimate, fill = EE_treatment)) +
  scale_y_continuous(expression(bold(TSM~(ºC))), expand =c(0,0), limits = c(1, 6.5)) +
  scale_x_discrete('Experimental evolution treatment', labels = treatment.labs) +
  scale_colour_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  scale_fill_manual(values=c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text.x=element_text(size=14, face="bold"),
        strip.text.y=element_text(size=14, face="bold"),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = 'top',
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
        guides(fill = FALSE, colour = FALSE)
TSM.plot
```

# PCA of TPC params
```{r}
#Prepare matrix and metdata for PCA
PCA.matrix <- TPC.extra_params_ave %>%
  ungroup() %>%
  dplyr::select(-c(EE_treatment, Replicate, model_name, med_estimate)) %>%
  pivot_wider(names_from = 'param', values_from = 'estimate') %>%
  column_to_rownames(var = "Lineage")

PCA.groups <- TPC.extra_params_ave %>% 
  ungroup() %>%
  dplyr::select(-c(Replicate, model_name, med_estimate)) %>%
  pivot_wider(names_from = 'param', values_from = 'estimate') %>%
  pull(EE_treatment)

#PCA
PCA.TPC <- prcomp(PCA.matrix, scale = T)

#Plot
PCA.TPC_biplot <- fviz_pca_biplot(PCA.TPC, repel = TRUE,
                             geom.ind = "point", pointshape=19, pointsize = 1.5, mean.point = FALSE,
                             fill.ind = PCA.groups, col.ind = PCA.groups, 
                             palette = c("#CC3311","#DDAA33", "#009988", "#0269A5", "#BBBBBB"),
                             #alpha.var ="contrib",
                             col.var = "black",
                             addEllipses = TRUE, ellipse.type = "confidence", ellipse.alpha = 0.2) +
  labs(title = "", x = "PC1: 41.9%", y = "PC2: 37.3%") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        title = element_blank(),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = 'top',
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, colour = "black", face = "bold"),
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.y = element_text(size = 14, colour = "black", face = "bold"), 
        axis.text.y = element_text(size = 12, colour = "black")) +
  guides(fill = F,alpha = F,
         shape = guide_legend(title = "Temperature (°C)"),
         color = guide_legend(title = "Experimental evolution treatment", override.aes = list(linetype = 0, fill = "white")))
PCA.TPC_biplot
```

# Combine all TPC plots
```{r}
TPC.EE.plots <- ggarrange(TPC.EE_CI.plot2,
                          TPC.EE_param.plot + rremove("legend"),
                          labels = c("(a)", "(b)"),
                          heights = c(0.75, 1),
                          widths = c(1, 1),
                          nrow = 2,
                          ncol = 1,
                          align = 'hv')
TPC.EE.plots
                          

TPC_params.plots <- ggarrange(Topt.plot + rremove("xlab") + rremove("x.text"),
                             CTmax.plot + rremove("xlab") + rremove("x.text"),
                             Tbr.plot + rremove("xlab") + rremove("x.text"),
                             TSM.plot + rremove("xlab") + rremove("x.text"),
                             CTmin.plot + rremove("xlab") + rremove("x.text"),
                             rmax.plot + rremove("xlab") + rremove("x.text"),
                             legend = "none",
                             labels = c("(b)", "(c)", "(d)", "(e)", "(f)", "(g)"),
                             heights = c(0.2, 0.2, 0.2, 0.2, 0.2, 0.2),
                             widths = c(0.2, 0.2, 0.2, 0.2, 0.2, 0.2),
                             nrow = 3,
                             ncol = 2,
                             align = "v") 
TPC_params.plots

TPC_PCA.plots <-  ggarrange(TPC.EE_CI.plot,
                            PCA.TPC_biplot,
                            common.legend = T,
                            labels = c("(a)", "(h)"),
                            heights = c(1, 1),
                            widths = c(0.5, 0.5),
                            ncol = 1,
                            align = "v")                            
TPC_PCA.plots

TPC.plots <- ggarrange(TPC_PCA.plots,
                       TPC_params.plots,
                       heights = c(1, 1),
                       widths = c(1, 0.5),
                       ncol = 2,
                       align = "hv")
TPC.plots

TPC.plots_annot <- annotate_figure(TPC.plots,
                                   bottom = text_grob("Experimental evolution treatment", color = "black", face = "bold", size = 14,
                                                        hjust = 1, x = 0.95))
TPC.plots_annot
```

# Save plots
```{r}
#Calibration curves
ggsave(plot = CC.plots, "Fig. S5.pdf",
       path = "./", 
       width = 10,
       height = 15, 
       units = 'in', 
       dpi = 600)

#Growth curves
ggsave(plot = GC.plots, "Fig. S4.pdf",
       path = "./", 
       width = 12.5,
       height = 15,
       units = 'in',
       dpi = 600)

#Growth rate model parameters
ggsave(plot = GrowthR.nls_params_plot, "Fig. S6.pdf", 
       path = "./", 
       width = 10,
       height = 15,
       units = 'in',
       dpi = 600,
       device = cairo_pdf)

#All TPC models by lineage
ggsave(plot = TPC.plot, "Fig. S7.pdf", 
       path = "./", 
       width = 12.5,
       height = 10,
       units = 'in',
       dpi = 600)

#TPCs with CIs by lineage
ggsave(plot = TPC.CI.plot, "Fig. S8.pdf", 
       path = "./", 
       width = 12.5,
       height = 10,
       units = 'in',
       dpi = 600)

#Average TPC by treatment, with CI
ggsave(plot = TPC.EE.plots, "Fig. S10.pdf", 
       path = "./", 
       width = 12.5,
       height = 10,
       units = 'in',
       dpi = 600)

#TPC params with CIs by lineage
ggsave(plot = TPC.param_CI.plot, "Fig. S9.pdf", 
       path = "./", 
       width = 12.5,
       height = 10,
       units = 'in',
       dpi = 600)

#All TPC plots combined
ggsave(plot = TPC.plots_annot, "Fig. 3.pdf", 
       path = "./", 
       width = 15,
       height = 12.5,
       units = 'in',
       dpi = 600)
```

# Export data
```{r}
TPC.param_xl <- TPC.extra_params_ave %>%
  ungroup() %>%
  dplyr::select(-EE_treatment, -model_name, -Replicate, -med_estimate) %>%
  pivot_wider(names_from = 'param', values_from = 'estimate') %>%
  write_xlsx(path = "./TPA - TPC param output.xlsx", 
             col_names = TRUE, 
             format_headers = TRUE)

TPC.param_CI_xl <- TPC.param_CI_ave %>%
  ungroup() %>%
  dplyr::select(EE_treatment, Replicate, param, estimate, conf_lower, conf_upper) %>%
  pivot_wider(names_from = 'param', values_from = c('estimate', 'conf_lower', 'conf_upper')) %>%
  write_xlsx(path = "./TPA - TPC param CI output.xlsx", 
             col_names = TRUE, 
             format_headers = TRUE)

GrowthR.data_xl <- GrowthR.df %>%
  filter(Growth_temperature == 27 | Growth_temperature == 31) %>%
  dplyr::select(Growth_temperature, Lineage, mumax) %>%
  distinct() %>%
  mutate(Lineage = str_replace(Lineage, "_", "-")) %>%
  arrange(by_group = Lineage) %>%
  write_xlsx(path = "./TPA - GrowthR output.xlsx", 
             col_names = TRUE, 
             format_headers = TRUE)

GrowthR_GC1.data_xl <- GrowthR_twop_GC1.df2 %>%
  #arrange(by_group = Lineage) %>%
  write_xlsx(path = "./TPA - GrowthR output.xlsx", 
             col_names = TRUE, 
             format_headers = TRUE)
```

